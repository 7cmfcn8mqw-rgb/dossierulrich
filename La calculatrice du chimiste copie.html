<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0" name="viewport"/>
<title>Calculatrice de masse molaire &amp; solutions (ions)</title>
<style>
  :root {
    --bg: #0f172a;
    --panel: #1e293b;
    --accent: #38bdf8;
    --text-main: #f8fafc;
    --text-dim: #94a3b8;
    --border: #475569;
    --cell-bg: #1e293b;
    --cell-hover: #334155;
    --radius-lg: 0.75rem;
    --radius-sm: 0.5rem;
    --font-stack: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  }

  body {
    margin:0;
    background:var(--bg);
    color:var(--text-main);
    font-family:var(--font-stack);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:1rem;
    gap:1rem;
  }

  h1{
    margin:0;
    font-size:clamp(1.1rem,1vw+1rem,1.4rem);
    font-weight:600;
    text-align:center;
    line-height:1.3;
  }

  .layout{
    width:100%;
    max-width:1400px;
    display:grid;
    gap:1.5rem;
  }
  @media(min-width:900px){
    .layout{
      grid-template-columns:320px 1fr;
      align-items:start;
    }
  }

  /* PANNEAU GAUCHE */
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    padding:1rem 1.25rem;
    display:flex;
    flex-direction:column;
    gap:1rem;
    box-shadow:0 30px 80px rgba(0,0,0,0.6);
  }

  .panel-section{
    background:rgba(15,23,42,0.4);
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    padding:0.75rem 1rem;
    display:flex;
    flex-direction:column;
    gap:0.5rem;
  }

  .label{
    font-size:0.75rem;
    letter-spacing:0.03em;
    color:var(--text-dim);
    font-weight:500;
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    row-gap:0.25rem;
  }

  .value-big{
    font-size:2rem;
    line-height:1.1;
    font-weight:600;
    color:var(--accent);
    word-break:break-word;
    font-variant-numeric:tabular-nums;
  }

  .formula-row{
    display:flex;
    flex-wrap:wrap;
    gap:0.5rem;
    font-size:1rem;
    line-height:1.4;
    color:var(--text-main);
  }

  .formula-chip{
    background:var(--cell-bg);
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    padding:0.4rem 0.5rem;
    font-weight:500;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-width:3rem;
  }

  .formula-chip-symbol{
    font-size:0.9rem;
    font-weight:600;
    line-height:1;
  }

  .formula-chip-mass{
    font-size:0.7rem;
    line-height:1;
    color:var(--text-dim);
  }

  .brute-wrapper{
    display:flex;
    flex-wrap:wrap;
    align-items:flex-start;
    row-gap:0.5rem;
    column-gap:0.5rem;
    font-size:1rem;
    line-height:1.4;
    color:var(--text-main);
  }

  .brute-label{
    font-weight:600;
    color:var(--text-main);
  }

  .buttons-row{
    display:flex;
    flex-wrap:wrap;
    gap:0.5rem;
  }

  button.action-btn{
    all:unset;
    cursor:pointer;
    background:var(--cell-bg);
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    padding:0.6rem 0.8rem;
    font-size:0.9rem;
    font-weight:500;
    line-height:1.2;
    color:var(--text-main);
    text-align:center;
    min-width:6rem;
  }
  button.action-btn:hover{
    background:var(--cell-hover);
  }

  /* COLONNE DROITE */
  .right-side-card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    box-shadow:0 30px 80px rgba(0,0,0,0.6);
    padding:1rem;
    display:flex;
    flex-direction:column;
    gap:1.5rem;
  }

  .elements-title{
    font-size:1rem;
    line-height:1.2;
    font-weight:600;
    color:var(--text-main);
    border:1px solid var(--text-main);
    border-radius:0.25rem;
    padding:0.4rem 0.5rem;
    display:inline-block;
  }

  .elements-header-ions{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    row-gap:0.5rem;
    column-gap:0.75rem;
  }

  .elements-section{
    display:flex;
    flex-direction:column;
    gap:1rem;
  }

  /* LIGNES D'ÉLÉMENTS */
  .elements-rows{
    display:flex;
    flex-direction:column;
    gap:1rem;
  }
  .element-row{
    display:flex;
    flex-wrap:wrap;
    gap:0.75rem;
  }

  /* Boutons d'éléments */
  .elem-btn{
    all:unset;
    cursor:pointer;
    background:var(--cell-bg);
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    padding:0.8rem 0.5rem;
    text-align:center;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:4.5rem;
    min-width:5rem;
  }
  .elem-btn:hover{
    background:var(--cell-hover);
  }

  .elem-sym{
    font-size:1.2rem;
    font-weight:600;
    color:var(--text-main);
    line-height:1.2;
  }

  .elem-mass{
    font-size:0.8rem;
    font-weight:500;
    color:var(--accent);
    line-height:1.3;
  }

  /* Styles spécifiques */
  .elem-btn.hydrogen{
    background:#475569;
    border:1px solid #94a3b8;
  }
  .elem-btn.hydrogen:hover{
    background:#64748b;
  }
  .elem-btn.hydrogen .elem-sym{
    color:#f8fafc;
  }
  .elem-btn.hydrogen .elem-mass{
    color:#e2e8f0;
  }

  .elem-btn.alkaline{
    background:#ffffff;
    border:1px solid #000000;
  }
  .elem-btn.alkaline:hover{
    background:#e2e8f0;
  }
  .elem-btn.alkaline .elem-sym{
    color:#000000;
  }
  .elem-btn.alkaline .elem-mass{
    color:#000000;
  }

  .elem-btn.transition{
    background:#dbeafe;
    border:1px solid #60a5fa;
  }
  .elem-btn.transition:hover{
    background:#bfdbfe;
  }
  .elem-btn.transition .elem-sym{
    color:#1e3a8a;
  }
  .elem-btn.transition .elem-mass{
    color:#1e40af;
  }

  .elem-btn.nonmetal{
    background:#14532d;
    border:1px solid #22c55e;
  }
  .elem-btn.nonmetal:hover{
    background:#166534;
  }
  .elem-btn.nonmetal .elem-sym{
    color:#f8fafc;
  }
  .elem-btn.nonmetal .elem-mass{
    color:#86efac;
  }

  /* Ions (rouge) */
  .elem-btn.ion{
    background:#7f1d1d;
    border:1px solid #ef4444;
  }
  .elem-btn.ion:hover{
    background:#991b1b;
  }
  .elem-btn.ion .elem-sym{
    color:#ffffff;
  }
  .elem-btn.ion .elem-mass{
    color:#fecaca;
  }

  /* grille ions */
  .elements-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(5rem,1fr));
    gap:0.75rem;
  }

  footer{
    color:var(--text-dim);
    font-size:0.7rem;
    text-align:center;
    line-height:1.4;
    max-width:1400px;
  }

  .version-box {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: #1e293b;
    border: 1px solid #94a3b8;
    border-radius: 0.5rem;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    color: #f8fafc;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
  }
  .version-box strong {
    display: block;
    font-weight: 600;
  }

  #countAtoms { display: none; }

  /* ----- switch pour afficher / masquer les ions composés ----- */
  .switch-wrapper {
    display:flex;
    align-items:center;
    gap:0.5rem;
    font-size:0.8rem;
    font-weight:500;
    color:var(--text-dim);
    user-select:none;
  }

  .toggle {
    --h:20px;
    width:38px;
    height:var(--h);
    background-color:#475569;
    border-radius:var(--h);
    border:1px solid var(--border);
    padding:2px;
    cursor:pointer;
    position:relative;
    transition:background-color .15s linear;
    flex-shrink:0;
  }

  .toggle-ball {
    width:calc(var(--h) - 4px);
    height:calc(var(--h) - 4px);
    background-color:#fff;
    border-radius:999px;
    position:absolute;
    left:2px;
    top:2px;
    transition:all .15s linear;
    box-shadow:0 6px 16px rgba(0,0,0,.4);
  }

  .toggle.active {
    background-color:var(--accent);
    border-color:var(--accent);
  }
  .toggle.active .toggle-ball {
    left:calc(100% - (var(--h) - 4px) - 2px);
    background-color:#0f172a;
  }

  /* ions list container (show/hide, grid by default when visible) */
  #ions-wrapper {
    display:none;
  }
  #ions-wrapper.visible {
    display:grid;
  }

  /* ---- Onglet de mode (Masse molaire / Solution) ---- */
  .mode-switch-container{
    display:flex;
    justify-content:center;
  }
  .mode-switch{
    display:inline-flex;
    align-items:center;
    border-radius:999px;
    border:1px solid var(--border);
    padding:0.15rem;
    background:rgba(15,23,42,0.85);
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
    margin-bottom:0.25rem;
  }
  .mode-btn{
    all:unset;
    cursor:pointer;
    padding:0.25rem 0.75rem;
    font-size:0.8rem;
    border-radius:999px;
    color:var(--text-dim);
    text-align:center;
  }
  .mode-btn.active{
    background:var(--accent);
    color:#0f172a;
    font-weight:600;
  }

  .hidden{
    display:none !important;
  }

  /* ---- Section calcul de solution ---- */
  .solution-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:0.75rem;
  }

  .solution-field label{
    font-size:0.75rem;
    color:var(--text-dim);
    margin-bottom:0.25rem;
    display:block;
  }

  .solution-field input{
    width:100%;
    border-radius:0.4rem;
    border:1px solid var(--border);
    background:var(--cell-bg);
    color:var(--text-main);
    padding:0.35rem 0.5rem;
    font-size:0.9rem;
    font-family:inherit;
  }

  .solution-field input:focus{
    outline:2px solid var(--accent);
    outline-offset:1px;
  }

  .solution-results{
    margin-top:0.75rem;
    display:flex;
    flex-direction:column;
    gap:0.25rem;
  }

  .solution-result-row{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    font-size:0.85rem;
    gap:0.25rem;
  }

  .solution-result-row span.value{
    font-variant-numeric:tabular-nums;
    min-width:4.5rem;
    text-align:right;
  }


  /* pH: section un peu plus grande */
  #phSection{ font-size: 1.06em; }
  #phSection input{ padding: 0.7rem 0.8rem; }
</style>
<style>
/* Added by script: small top-left home button */
.home-btn{
  position:fixed;
  top:8px;
  left:8px;
  width:22px;
  height:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  font-size:14px;
  line-height:1;
  border-radius:6px;
  background:rgba(255,255,255,0.8);
  color:#111;
  border:1px solid rgba(0,0,0,0.25);
  box-shadow:0 1px 3px rgba(0,0,0,0.15);
  z-index:2147483647;
}
.home-btn:hover{ background:rgba(255,255,255,0.95); }
.home-btn:active{ transform:translateY(1px); }
@media (prefers-color-scheme: dark){
  .home-btn{
    background:rgba(30,30,30,0.75);
    color:#f5f5f5;
    border:1px solid rgba(255,255,255,0.25);
  }
}

</style>
</head>
<body>
<a href="https://7cmfcn8mqw-rgb.github.io/dossierulrich/" class="home-btn" aria-label="Retour au menu principal" title="Menu">⟵</a>

<div class="version-box"><strong>Version 1.20</strong>S. Ulrich<br/>ECG Henry-Dunant</div>
<h1>La calculatrice simplifiée du chimiste</h1>
<div class="mode-switch-container">
<div aria-label="Mode de la calculatrice" class="mode-switch" role="tablist">
<button aria-selected="true" class="mode-btn active" data-mode="molar-mass" role="tab">
      Masse molaire
    </button>
<button aria-selected="false" class="mode-btn" data-mode="solution" role="tab">
      Solution
    </button>
<button aria-selected="false" class="mode-btn" data-mode="ph" role="tab">
      pH (acide/base)
    </button>
</div>
</div>
<div class="layout">
<!-- COLONNE GAUCHE -->
<section class="panel">
<div class="panel-section">
<div class="label">
<span>Masse molaire totale</span>
<span>(g/mol)</span>
</div>
<div class="value-big" id="totalMass">0.0</div>
</div>
<div class="panel-section">
<div class="label">
<span>Éléments ajoutés</span>
<span id="countAtoms">0 atome(s)</span>
</div>
<div class="formula-row" id="formulaRow"></div>
</div>
<div class="panel-section">
<div class="brute-wrapper">
<div class="brute-label">Formule brute :</div>
<div id="bruteFormulaText">—</div>
</div>
</div>
<!-- SECTION : mode solution -->
<div class="panel-section hidden" id="solutionSection">
<div class="label">
<span>Calcul de solution</span>
<span>(utilise la masse molaire ci-dessus)</span>
</div>
<div class="solution-grid">
<div class="solution-field">
<label for="massInput">Masse de soluté m (g)</label>
<input id="massInput" inputmode="decimal" min="0" step="0.01" type="number"/>
</div>
<div class="solution-field">
<label for="volumeInput">Volume de solution V (L)</label>
<input id="volumeInput" inputmode="decimal" min="0" step="0.001" type="number"/>
</div>
<div class="solution-field">
<label for="nInput">Nombre de môles n (mol)</label>
<input id="nInput" inputmode="decimal" min="0" step="0.0001" type="number"/>
</div>
<div class="solution-field">
<label for="pHInput">pH</label>
<input id="pHInput" inputmode="decimal" step="0.01" type="number"/>
</div>
</div>
<div class="solution-results">
<div class="solution-result-row">
<span>Molarité C</span>
<span class="value" id="cValue">—</span>
<span>mol·L⁻¹</span>
</div>
<div class="solution-result-row">
<span>Titre T</span>
<span class="value" id="tValue">—</span>
<span>g·L⁻¹</span>
</div>
<div class="solution-result-row" style="display:none">
<span>Nombre de môles n</span>
<span class="value" id="nValue">—</span>
<span>mol</span>
</div>
<div class="solution-result-row">
<span>Valeur du pH</span>
<span class="value" id="pHDisplay">—</span>
<span></span>
</div>
</div>
</div>
<!-- SECTION : mode pH -->
<div class="panel-section hidden" id="phSection">
<div class="label">
<span>Calcul du pH</span>
</div>
<div class="solution-grid">
<div class="field">
<label for="phFormula">Formule brute</label>
<input id="phFormula" placeholder="ex: HCl, H2SO4, NaOH, AlOH3"/>
</div>
<div class="field">
<label for="phConc">Concentration (mol/L)</label>
<input id="phConc" placeholder="ex: 0,01"/>
        <label for="ph_titre">Titre (g/L)</label>
        <input id="ph_titre" type="text" placeholder="ex : 3,65">
        
</div><div class="field"><label for="phGiven">OU pH donné</label><input id="phGiven" placeholder="ex: 2"/></div>
<div class="field">
<button class="primary" id="phCalcBtn" type="button">Calculer</button>
</div>
<div class="field">
<div class="result-box">
<div><strong>Résultat :</strong> <span id="phOut">—</span></div>


</div>
</div>
</div>
</div>
<div class="buttons-row">
<button class="action-btn" id="undoBtn">Annuler dernier</button>
<button class="action-btn" id="resetBtn">Réinitialiser</button>
</div>
</section>
<!-- COLONNE DROITE -->
<section class="right-side-card">
<div class="elements-title">Tableau périodique</div>
<div class="elements-section">
<div class="elements-rows">
<!-- LIGNE 1 : H (gris) + éléments blancs -->
<div class="element-row">
<button class="elem-btn hydrogen" data-mass="1" data-sym="H">
<div class="elem-sym">H</div>
<div class="elem-mass">1</div>
</button>
<button class="elem-btn alkaline" data-mass="23" data-sym="Na">
<div class="elem-sym">Na</div>
<div class="elem-mass">23</div>
</button>
<button class="elem-btn alkaline" data-mass="39" data-sym="K">
<div class="elem-sym">K</div>
<div class="elem-mass">39</div>
</button>
<button class="elem-btn alkaline" data-mass="40" data-sym="Ca">
<div class="elem-sym">Ca</div>
<div class="elem-mass">40</div>
</button>
<button class="elem-btn alkaline" data-mass="24" data-sym="Mg">
<div class="elem-sym">Mg</div>
<div class="elem-mass">24</div>
</button>
</div>
<!-- LIGNE 2 : métaux de transition (bleu ciel) -->
<div class="element-row">
<button class="elem-btn transition" data-mass="56" data-sym="Fe">
<div class="elem-sym">Fe</div>
<div class="elem-mass">56</div>
</button>
<button class="elem-btn transition" data-mass="63.5" data-sym="Cu">
<div class="elem-sym">Cu</div>
<div class="elem-mass">63.5</div>
</button>
<button class="elem-btn transition" data-mass="65" data-sym="Zn">
<div class="elem-sym">Zn</div>
<div class="elem-mass">65</div>
</button>
<button class="elem-btn transition" data-mass="108" data-sym="Ag">
<div class="elem-sym">Ag</div>
<div class="elem-mass">108</div>
</button>
<button class="elem-btn transition" data-mass="197" data-sym="Au">
<div class="elem-sym">Au</div>
<div class="elem-mass">197</div>
</button>
</div>
<!-- LIGNE 3 : non-métaux (verts) -->
<div class="element-row">
<button class="elem-btn nonmetal" data-mass="12" data-sym="C">
<div class="elem-sym">C</div>
<div class="elem-mass">12</div>
</button>
<button class="elem-btn nonmetal" data-mass="14" data-sym="N">
<div class="elem-sym">N</div>
<div class="elem-mass">14</div>
</button>
<button class="elem-btn nonmetal" data-mass="16" data-sym="O">
<div class="elem-sym">O</div>
<div class="elem-mass">16</div>
</button>
<button class="elem-btn nonmetal" data-mass="32" data-sym="S">
<div class="elem-sym">S</div>
<div class="elem-mass">32</div>
</button>
<button class="elem-btn nonmetal" data-mass="35.5" data-sym="Cl">
<div class="elem-sym">Cl</div>
<div class="elem-mass">35.5</div>
</button>
</div>
</div>
</div>
<div class="elements-header-ions">
<div class="elements-title">Ions composés</div>
<div class="switch-wrapper">
<span>afficher</span>
<div aria-checked="false" class="toggle" id="toggle-ions" role="switch" tabindex="0">
<div class="toggle-ball"></div>
</div>
</div>
</div>
<div class="elements-section">
<div class="elements-grid" id="ions-wrapper">
<!-- IONS ROUGES -->
<button class="elem-btn ion" data-mass="17" data-sym="OH">
<div class="elem-sym">OH<sup>−</sup></div>
<div class="elem-mass">17</div>
</button>
<button class="elem-btn ion" data-mass="95" data-sym="PO4">
<div class="elem-sym">PO₄<sup>3−</sup></div>
<div class="elem-mass">95</div>
</button>
<button class="elem-btn ion" data-mass="96" data-sym="SO4">
<div class="elem-sym">SO₄<sup>2−</sup></div>
<div class="elem-mass">96</div>
</button>
<button class="elem-btn ion" data-mass="60" data-sym="CO3">
<div class="elem-sym">CO₃<sup>2−</sup></div>
<div class="elem-mass">60</div>
</button>
<button class="elem-btn ion" data-mass="18" data-sym="NH4">
<div class="elem-sym">NH₄<sup>+</sup></div>
<div class="elem-mass">18</div>
</button>
<button class="elem-btn ion" data-mass="62" data-sym="NO3">
<div class="elem-sym">NO₃<sup>−</sup></div>
<div class="elem-mass">62</div>
</button>
</div>
</div>
</section>
</div>
<footer>
  Clique sur un élément ou un ion pour l'ajouter au calcul, puis utilise l'onglet « Solution » pour calculer la molarité, le titre, le pH, le pOH et le nombre de môles.
</footer>
<script>
  
function toNumber(v){
  if (v === null || v === undefined) return NaN;
  v = String(v).trim();
  if (!v) return NaN;
  v = v.replace(',', '.').replace('−','-');
  return Number(v);
}


function molarMassFromFormula(formula){
  const masses = (typeof atomicMasses !== "undefined") ? atomicMasses :
                 (typeof masseAtomique !== "undefined") ? masseAtomique :
                 (typeof massesAtomiques !== "undefined") ? massesAtomiques : null;
  if (!masses) return NaN;

  formula = String(formula || "").trim();
  if (!formula) return NaN;

  let i = 0;
  function num(){ let n=""; while(i<formula.length && /[0-9]/.test(formula[i])) n+=formula[i++]; return n?parseInt(n,10):1; }
  function el(){ if(!/[A-Z]/.test(formula[i])) return null; let s=formula[i++]; if(/[a-z]/.test(formula[i])) s+=formula[i++]; return s; }
  function grp(){
    let t=0;
    while(i<formula.length){
      if(formula[i]===')') break;
      if(formula[i]==='('){ i++; const g=grp(); if(formula[i]===')') i++; t+=g*num(); continue; }
      const e=el(); if(!e){ i++; continue; }
      const m=masses[e]; if(m===undefined) return NaN;
      t+=m*num();
    }
    return t;
  }
  i=0; return grp();
}

// -------------------------
  // Données de chimie
  // -------------------------

  // Ions polyatomiques -> composition atomique
  const POLY_EXPAND = {
    "OH":  { "O":1, "H":1 },
    "PO4": { "P":1, "O":4 },
    "SO4": { "S":1, "O":4 },
    "CO3": { "C":1, "O":3 },
    "NH4": { "N":1, "H":4 },
    "NO3": { "N":1, "O":3 }
  };

  // Ensemble des symboles qui NE sont pas de simples atomes
  const POLYATOMIC = new Set(["OH","PO4","SO4","CO3","NH4","NO3"]);

  // Formules autorisées pour affichage en "Formule brute"
  // - display : string HTML avec indices <sub> et parenthèses si besoin
  // - comp    : composition totale en atomes simples
  const FORMULAS = [
    // molécules simples / diatomiques / triatomiques
    {display:"H<sub>2</sub>",                 comp:{H:2}},
    {display:"O<sub>2</sub>",                 comp:{O:2}},
    {display:"N<sub>2</sub>",                 comp:{N:2}},
    {display:"Cl<sub>2</sub>",                comp:{Cl:2}},
    {display:"O<sub>3</sub>",                 comp:{O:3}},

    // hydrides, eau, dérivés oxygénés simples
    {display:"H<sub>2</sub>O",                comp:{H:2,O:1}},
    {display:"H<sub>2</sub>O<sub>2</sub>",    comp:{H:2,O:2}},
    {display:"H<sub>2</sub>S",                comp:{H:2,S:1}},
    {display:"NH<sub>3</sub>",                comp:{N:1,H:3}},
    {display:"CO",                            comp:{C:1,O:1}},
    {display:"CO<sub>2</sub>",                comp:{C:1,O:2}},
    {display:"SO<sub>2</sub>",                comp:{S:1,O:2}},
    {display:"SO<sub>3</sub>",                comp:{S:1,O:3}},
    {display:"NO",                            comp:{N:1,O:1}},
    {display:"NO<sub>2</sub>",                comp:{N:1,O:2}},
    {display:"N<sub>2</sub>O",                comp:{N:2,O:1}},

    // acides minéraux
    {display:"HCl",                           comp:{H:1,Cl:1}},
    {display:"HNO<sub>3</sub>",               comp:{H:1,N:1,O:3}},
    {display:"H<sub>2</sub>SO<sub>4</sub>",   comp:{H:2,S:1,O:4}},
    {display:"H<sub>3</sub>PO<sub>4</sub>",   comp:{H:3,P:1,O:4}},

    // alcanes / alcènes / alcynes / acide éthanoïque
    {display:"CH<sub>4</sub>",                comp:{C:1,H:4}},
    {display:"C<sub>2</sub>H<sub>6</sub>",    comp:{C:2,H:6}},
    {display:"C<sub>2</sub>H<sub>4</sub>",    comp:{C:2,H:4}},
    {display:"C<sub>2</sub>H<sub>2</sub>",    comp:{C:2,H:2}},
    {display:"C<sub>2</sub>H<sub>4</sub>O<sub>2</sub>", comp:{C:2,H:4,O:2}},

    // oxydes métalliques
    {display:"Na<sub>2</sub>O",               comp:{Na:2,O:1}},
    {display:"K<sub>2</sub>O",                comp:{K:2,O:1}},
    {display:"MgO",                           comp:{Mg:1,O:1}},
    {display:"CaO",                           comp:{Ca:1,O:1}},
    {display:"FeO",                           comp:{Fe:1,O:1}},
    {display:"Fe<sub>2</sub>O<sub>3</sub>",   comp:{Fe:2,O:3}},
    {display:"CuO",                           comp:{Cu:1,O:1}},
    {display:"Cu<sub>2</sub>O",               comp:{Cu:2,O:1}},
    {display:"ZnO",                           comp:{Zn:1,O:1}},
    {display:"Ag<sub>2</sub>O",               comp:{Ag:2,O:1}},
    {display:"Au<sub>2</sub>O<sub>3</sub>",   comp:{Au:2,O:3}},

    // hydroxydes
    {display:"NaOH",                          comp:{Na:1,O:1,H:1}},
    {display:"KOH",                           comp:{K:1,O:1,H:1}},
    {display:"Ca(OH)<sub>2</sub>",            comp:{Ca:1,O:2,H:2}},
    {display:"Mg(OH)<sub>2</sub>",            comp:{Mg:1,O:2,H:2}},
    {display:"Fe(OH)<sub>2</sub>",            comp:{Fe:1,O:2,H:2}},
    {display:"Fe(OH)<sub>3</sub>",            comp:{Fe:1,O:3,H:3}},
    {display:"Cu(OH)<sub>2</sub>",            comp:{Cu:1,O:2,H:2}},
    {display:"Zn(OH)<sub>2</sub>",            comp:{Zn:1,O:2,H:2}},
    {display:"AgOH",                          comp:{Ag:1,O:1,H:1}},
    {display:"Au(OH)<sub>3</sub>",            comp:{Au:1,O:3,H:3}},
    {display:"NH<sub>4</sub>OH",              comp:{N:1,H:5,O:1}},

    // chlorures métalliques
    {display:"NaCl",                          comp:{Na:1,Cl:1}},
    {display:"KCl",                           comp:{K:1,Cl:1}},
    {display:"CaCl<sub>2</sub>",              comp:{Ca:1,Cl:2}},
    {display:"MgCl<sub>2</sub>",              comp:{Mg:1,Cl:2}},
    {display:"FeCl<sub>2</sub>",              comp:{Fe:1,Cl:2}},
    {display:"FeCl<sub>3</sub>",              comp:{Fe:1,Cl:3}},
    {display:"CuCl",                          comp:{Cu:1,Cl:1}},
    {display:"CuCl<sub>2</sub>",              comp:{Cu:1,Cl:2}},
    {display:"ZnCl<sub>2</sub>",              comp:{Zn:1,Cl:2}},
    {display:"AgCl",                          comp:{Ag:1,Cl:1}},
    {display:"AuCl<sub>3</sub>",              comp:{Au:1,Cl:3}},
    {display:"NH<sub>4</sub>Cl",              comp:{N:1,H:4,Cl:1}},

    // sulfates
    {display:"Na<sub>2</sub>SO<sub>4</sub>",  comp:{Na:2,S:1,O:4}},
    {display:"K<sub>2</sub>SO<sub>4</sub>",   comp:{K:2,S:1,O:4}},
    {display:"CaSO<sub>4</sub>",              comp:{Ca:1,S:1,O:4}},
    {display:"MgSO<sub>4</sub>",              comp:{Mg:1,S:1,O:4}},
    {display:"FeSO<sub>4</sub>",              comp:{Fe:1,S:1,O:4}},
    {display:"Fe<sub>2</sub>(SO<sub>4</sub>)<sub>3</sub>", comp:{Fe:2,S:3,O:12}},
    {display:"CuSO<sub>4</sub>",              comp:{Cu:1,S:1,O:4}},
    {display:"ZnSO<sub>4</sub>",              comp:{Zn:1,S:1,O:4}},
    {display:"Ag<sub>2</sub>SO<sub>4</sub>",  comp:{Ag:2,S:1,O:4}},
    {display:"(NH<sub>4</sub>)<sub>2</sub>SO<sub>4</sub>", comp:{N:2,H:8,S:1,O:4}},

    // carbonates
    {display:"Na<sub>2</sub>CO<sub>3</sub>",  comp:{Na:2,C:1,O:3}},
    {display:"K<sub>2</sub>CO<sub>3</sub>",   comp:{K:2,C:1,O:3}},
    {display:"CaCO<sub>3</sub>",              comp:{Ca:1,C:1,O:3}},
    {display:"MgCO<sub>3</sub>",              comp:{Mg:1,C:1,O:3}},
    {display:"FeCO<sub>3</sub>",              comp:{Fe:1,C:1,O:3}},
    {display:"ZnCO<sub>3</sub>",              comp:{Zn:1,C:1,O:3}},
    {display:"CuCO<sub>3</sub>",              comp:{Cu:1,C:1,O:3}},
    {display:"(NH<sub>4</sub>)<sub>2</sub>CO<sub>3</sub>", comp:{N:2,H:8,C:1,O:3}},

    // nitrates
    {display:"NaNO<sub>3</sub>",              comp:{Na:1,N:1,O:3}},
    {display:"KNO<sub>3</sub>",               comp:{K:1,N:1,O:3}},
    {display:"Ca(NO<sub>3</sub>)<sub>2</sub>", comp:{Ca:1,N:2,O:6}},
    {display:"Mg(NO<sub>3</sub>)<sub>2</sub>", comp:{Mg:1,N:2,O:6}},
    {display:"Fe(NO<sub>3</sub>)<sub>2</sub>", comp:{Fe:1,N:2,O:6}},
    {display:"Fe(NO<sub>3</sub>)<sub>3</sub>", comp:{Fe:1,N:3,O:9}},
    {display:"Cu(NO<sub>3</sub>)<sub>2</sub>", comp:{Cu:1,N:2,O:6}},
    {display:"Zn(NO<sub>3</sub>)<sub>2</sub>", comp:{Zn:1,N:2,O:6}},
    {display:"AgNO<sub>3</sub>",              comp:{Ag:1,N:1,O:3}},
    {display:"NH<sub>4</sub>NO<sub>3</sub>",   comp:{N:2,H:4,O:3}},

    // phosphates
    {display:"Na<sub>3</sub>PO<sub>4</sub>",  comp:{Na:3,P:1,O:4}},
    {display:"K<sub>3</sub>PO<sub>4</sub>",   comp:{K:3,P:1,O:4}},
    {display:"Ca<sub>3</sub>(PO<sub>4</sub>)<sub>2</sub>", comp:{Ca:3,P:2,O:8}},
    {display:"Mg<sub>3</sub>(PO<sub>4</sub>)<sub>2</sub>", comp:{Mg:3,P:2,O:8}},
    {display:"FePO<sub>4</sub>",              comp:{Fe:1,P:1,O:4}},
    {display:"Zn<sub>3</sub>(PO<sub>4</sub>)<sub>2</sub>", comp:{Zn:3,P:2,O:8}},
    {display:"(NH<sub>4</sub>)<sub>3</sub>PO<sub>4</sub>", comp:{N:3,H:12,P:1,O:4}},

    // SULFURES
    {display:"Na<sub>2</sub>S",               comp:{Na:2,S:1}},
    {display:"K<sub>2</sub>S",                comp:{K:2,S:1}},
    {display:"CaS",                           comp:{Ca:1,S:1}},
    {display:"MgS",                           comp:{Mg:1,S:1}},
    {display:"FeS",                           comp:{Fe:1,S:1}},
    {display:"Fe<sub>2</sub>S<sub>3</sub>",   comp:{Fe:2,S:3}},
    {display:"CuS",                           comp:{Cu:1,S:1}},
    {display:"Cu<sub>2</sub>S",               comp:{Cu:2,S:1}},
    {display:"ZnS",                           comp:{Zn:1,S:1}},
    {display:"Ag<sub>2</sub>S",               comp:{Ag:2,S:1}},
    {display:"Au<sub>2</sub>S<sub>3</sub>",   comp:{Au:2,S:3}},
    {display:"(NH<sub>4</sub>)<sub>2</sub>S", comp:{N:2,H:8,S:1}}
  ];

  // -------------------------
  // Fonctions pour espèces fortes (acides / hydroxydes)
  // -------------------------
  function compositionKey(comp){
    const keys = Object.keys(comp).sort();
    return keys.map(k => k + ":" + comp[k]).join("|");
  }

  const STRONG_SPECIES = {};
  function addSpecies(comp, kind, mult){
    STRONG_SPECIES[compositionKey(comp)] = { kind, mult };
  }

  // Acides forts gérés : HCl, HNO3, H2SO4 (2 H+)
  addSpecies({H:1,Cl:1},           "acid", 1); // HCl
  addSpecies({H:1,N:1,O:3},        "acid", 1); // HNO3
  addSpecies({H:2,S:1,O:4},        "acid", 2); // H2SO4

  // Hydroxydes forts gérés : NaOH, KOH, Ca(OH)2, Mg(OH)2
  addSpecies({Na:1,O:1,H:1},       "base", 1); // NaOH
  addSpecies({K:1,O:1,H:1},        "base", 1); // KOH
  addSpecies({Ca:1,O:2,H:2},       "base", 2); // Ca(OH)2
  addSpecies({Mg:1,O:2,H:2},       "base", 2); // Mg(OH)2

  function detectStrongSpecies(expandedCounts){
    const key = compositionKey(expandedCounts);
    return STRONG_SPECIES[key] || null;
  }

  // -------------------------
  // DOM elements
  // -------------------------
  const totalMassEl = document.getElementById("totalMass");
  const countAtomsEl = document.getElementById("countAtoms");
  const formulaRowEl = document.getElementById("formulaRow");
  const bruteFormulaTextEl = document.getElementById("bruteFormulaText");

  const undoBtn = document.getElementById("undoBtn");
  const resetBtn = document.getElementById("resetBtn");

  // toggle ions
  const toggleIons = document.getElementById("toggle-ions");
  const ionsWrapper = document.getElementById("ions-wrapper");

  // mode + solution
  const solutionSection = document.getElementById("solutionSection");
  const massInput = document.getElementById("massInput");
  const volumeInput = document.getElementById("volumeInput");
  const nInput = document.getElementById("nInput");
  const pHInput = document.getElementById("pHInput");
  const nValueEl = document.getElementById("nValue");
  const cValueEl = document.getElementById("cValue");
  const tValueEl = document.getElementById("tValue");
  const pHValueEl = document.getElementById("pHValue");
  const pOHValueEl = document.getElementById("pOHValue");
  const modeButtons = document.querySelectorAll(".mode-btn");

  // -------------------------
  // État
  // -------------------------
  let atomList = [];
  let currentMode = "molar-mass";
  let currentSpecies = null; // acide fort ou hydroxyde reconnu
  let lastEdited = null; // dernier champ modifié: "mass", "n" ou "volume"

  // -------------------------
  // Utilitaires calcul
  // -------------------------

  function addAtom(sym, mass){
    atomList.push({ sym, mass: parseFloat(mass) });
    refreshDisplay();
  }

  function undoLast(){
    atomList.pop();
    refreshDisplay();
  }

  function resetAll(){
    atomList = [];
    if (massInput) massInput.value = "";
    if (volumeInput) volumeInput.value = "";
    refreshDisplay();
  }

  undoBtn.addEventListener("click", undoLast);
  resetBtn.addEventListener("click", resetAll);

  // masse totale
  function computeTotalMass(list){
    return list.reduce((acc,a)=>acc+a.mass,0);
  }

  // expansion en vrais atomes (Na, H, O, ...)
  function expandToTrueAtoms(list){
    const expanded = {};
    list.forEach(a => {
      const sym = a.sym;
      if (POLYATOMIC.has(sym)){
        const exp = POLY_EXPAND[sym];
        for(const el in exp){
          expanded[el] = (expanded[el] || 0) + exp[el];
        }
      } else {
        expanded[sym] = (expanded[sym] || 0) + 1;
      }
    });
    return expanded;
  }

  // compare deux compos (ex: {H:2,O:1})
  function sameComposition(a, b){
    const keysA = Object.keys(a);
    const keysB = Object.keys(b);
    if(keysA.length !== keysB.length) return false;
    for(const k of keysA){
        if(a[k] !== b[k]) return false;
    }
    return true;
  }

  // cherche une formule officielle
  function findOfficialFormula(expandedCounts){
    for(const f of FORMULAS){
      if(sameComposition(expandedCounts, f.comp)){
        return f.display;
      }
    }
    return "";
  }

  // parse un nombre en acceptant éventuellement une virgule
  function parseNumber(value){
    if (value == null || value === "") return NaN;
    return parseFloat(String(value).replace(",", "."));
  }

  // format à trois chiffres significatifs (sous forme de chaîne)
  function format3Sig(x){
    if (!isFinite(x)) return "—";
    return x.toPrecision(3);
  }

  // -------------------------
  // Affichage / masquage ions composés
  // -------------------------
  function setIonsVisible(visible){
    if (visible){
      ionsWrapper.classList.add("visible");
      toggleIons.classList.add("active");
      toggleIons.setAttribute("aria-checked","true");
    } else {
      ionsWrapper.classList.remove("visible");
      toggleIons.classList.remove("active");
      toggleIons.setAttribute("aria-checked","false");
    }
  }

  // état initial: masqué
  let ionsVisible = false;
  setIonsVisible(ionsVisible);

  toggleIons.addEventListener("click", ()=>{
    ionsVisible = !ionsVisible;
    setIonsVisible(ionsVisible);
  });

  toggleIons.addEventListener("keydown", (e)=>{
    if(e.key === " " || e.key === "Enter"){
      e.preventDefault();
      ionsVisible = !ionsVisible;
      setIonsVisible(ionsVisible);
    }
  });

  // -------------------------
  // Mode calculatrice (onglets)
  // -------------------------
  function setMode(mode){
    currentMode = mode;

    // boutons
    modeButtons.forEach(btn=>{
      const isActive = btn.dataset.mode === mode;
      btn.classList.toggle("active", isActive);
      btn.setAttribute("aria-selected", isActive ? "true" : "false");
    });

    // sections
    if (solutionSection){
      solutionSection.classList.toggle("hidden", mode !== "solution");
    }
    const phSection = document.getElementById("phSection");
    if (phSection){
      phSection.classList.toggle("hidden", mode !== "ph");
    }
    // auto-remplissage de la formule dans l'onglet pH depuis la formule brute affichée
    if (mode === "ph"){
      const fEl = document.getElementById("phFormula");
      const bruteEl = document.getElementById("bruteFormulaText");
      const brute = bruteEl ? (bruteEl.textContent || "").trim() : "";
      if (fEl && brute && brute !== "—" && fEl.dataset.manual !== "1"){
        fEl.value = brute;
      }
    }

  }
  if (modeButtons && modeButtons.length){
    modeButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const mode = btn.dataset.mode || "molar-mass";
        setMode(mode);
      });
    });
  }
  // -------------------------
  // Calcul de solution + pH / pOH
  // -------------------------
  
  function updateSolutionOutputs(){
    if (!volumeInput || !nValueEl || !cValueEl || !tValueEl) return;

    const M = computeTotalMass(atomList);           // g/mol
    const V = parseNumber(volumeInput.value);       // L

    let m = massInput ? parseNumber(massInput.value) : NaN; // g
    let n = nInput   ? parseNumber(nInput.value)   : NaN;   // mol
    let pHIn = pHInput ? parseNumber(pHInput.value) : NaN;  // pH saisi éventuellement

    let nText = "—";
    let cText = "—";
    let tText = "—";
    let pHText = "—";
    let pOHText = "—";

    // Relation entre masse et nombre de moles (comme avant)
    if (M > 0){
      if (!isNaN(n) && (lastEdited === "n" || isNaN(m))){
        // On part du nombre de moles pour calculer la masse
        m = n * M;
        if (massInput && isFinite(m)){
          massInput.value = m;
        }
      } else if (!isNaN(m)){
        // On part de la masse pour calculer le nombre de moles
        n = m / M;
        if (nInput && isFinite(n)){
          nInput.value = n;
        }
      }
    }

    // Titre massique T = m / V (g/L)
    if (!isNaN(m) && !isNaN(V) && V > 0){
      const t = m / V;
      tText = format3Sig(t);
    }

    // Concentration molaire C = n / V (mol/L) - version standard (sera éventuellement écrasée par pH saisi)
    let c = NaN;
    if (!isNaN(n)){
      nText = format3Sig(n);
      if (!isNaN(V) && V > 0){
        c = n / V;
        cText = format3Sig(c);
      }
    }

    // pH / pOH si acide fort ou base forte reconnue
    // et affichage spécifique dans la ligne "Valeur du pH" de la partie solution
    const pHDisplayEl = document.getElementById("pHDisplay");

    if (currentSpecies && (currentSpecies.kind === "acid" || currentSpecies.kind === "base")){
      // PRIORITÉ AU pH SAISI : si l'utilisateur introduit un pH, on recalcule C, T, n à partir de ce pH
      if (!isNaN(pHIn)){
        if (currentSpecies.kind === "acid"){
          // Un acide ne doit jamais avoir un pH > 7
          let pH = pHIn;
          if (pH > 7) pH = 7;

          const H = Math.pow(10, -pH);          // [H3O+]
          c = H / currentSpecies.mult;          // C = [H3O+]/mult
          cText = format3Sig(c);

          if (M > 0){
            const t = c * M;                    // T = C·M
            tText = format3Sig(t);
          }

          if (!isNaN(V) && V > 0){
            n = c * V;                          // n = C·V
            nText = format3Sig(n);
          }

          const pOH = 14 - pH;
          pHText = format3Sig(pH);
          pOHText = format3Sig(pOH);

        } else if (currentSpecies.kind === "base"){
          // Une base ne doit jamais avoir un pH < 7
          let pH = pHIn;
          if (pH < 7) pH = 7;

          const pOH = 14 - pH;
          const OH = Math.pow(10, -pOH);        // [OH-]
          c = OH / currentSpecies.mult;         // C = [OH-]/mult
          cText = format3Sig(c);

          if (M > 0){
            const t = c * M;                    // T = C·M
            tText = format3Sig(t);
          }

          if (!isNaN(V) && V > 0){
            n = c * V;                          // n = C·V
            nText = format3Sig(n);
          }

          pHText = format3Sig(pH);
          pOHText = format3Sig(pOH);
        }

        if (pHDisplayEl) pHDisplayEl.textContent = pHText;

      } else if (c > 0){
        // PAS DE pH SAISI : on calcule le pH à partir de C comme avant
        if (currentSpecies.kind === "acid"){
          const H = currentSpecies.mult * c;           // [H3O+]
          let pH = -Math.log10(H);

          // Un acide ne doit jamais avoir un pH > 7
          if (pH > 7){
            pH = 7;
          }

          const pOH = 14 - pH;
          pHText = format3Sig(pH);
          pOHText = format3Sig(pOH);

        } else if (currentSpecies.kind === "base"){
          const OH = currentSpecies.mult * c;          // [OH-]
          let pOH = -Math.log10(OH);
          let pH = 14 - pOH;

          // Une base ne doit jamais avoir un pH < 7
          if (pH < 7){
            pH = 7;
            pOH = 14 - pH;
          }

          pHText = format3Sig(pH);
          pOHText = format3Sig(pOH);
        }

        if (pHDisplayEl) pHDisplayEl.textContent = pHText;

      } else {
        // Espèce reconnue mais pas de concentration exploitable
        if (pHDisplayEl) pHDisplayEl.textContent = "valeur du pH inconnue (?)";
      }

    } else {
      // Pas d'espèce ou espèce non traitée comme acide/base forte
      if (pHDisplayEl) pHDisplayEl.textContent = "valeur du pH inconnue (?)";
    }

    nValueEl.textContent = nText;
    cValueEl.textContent = cText;
    tValueEl.textContent = tText;
    if (pHValueEl)  pHValueEl.textContent  = pHText;
    if (pOHValueEl) pOHValueEl.textContent = pOHText;
  }

  if (massInput){
    massInput.addEventListener("input", ()=>{
      lastEdited = "mass";
      updateSolutionOutputs();
    });
  }
  if (nInput){
    nInput.addEventListener("input", ()=>{
      lastEdited = "n";
      updateSolutionOutputs();
    });
  }
  if (pHInput){
    pHInput.addEventListener("input", ()=>{
      lastEdited = "pH";
      updateSolutionOutputs();
    });
  }
  if (volumeInput){
    volumeInput.addEventListener("input", ()=>{
      lastEdited = "volume";
      updateSolutionOutputs();
    });
  }

// -------------------------
  // Rafraîchissement UI
  // -------------------------
  function refreshDisplay(){
    // masse
    const total = computeTotalMass(atomList);
    totalMassEl.textContent = total.toFixed(1);

    // nb ajouts
    countAtomsEl.textContent = atomList.length + " atome(s)";

    // historique des clics
    formulaRowEl.innerHTML = "";
    atomList.forEach(a=>{
      const chip = document.createElement("div");
      chip.className = "formula-chip";
      chip.innerHTML = `
        <div class="formula-chip-symbol">${a.sym}</div>
        <div class="formula-chip-mass">${a.mass}</div>
      `;
      formulaRowEl.appendChild(chip);
    });

    // formule brute reconnue ou "—"
    const expanded = expandToTrueAtoms(atomList);
    const official = findOfficialFormula(expanded);
    bruteFormulaTextEl.innerHTML = official || "—";

    // auto-remplissage du champ "Formule brute" dans l\'onglet pH
    const phFormulaAuto = document.getElementById("phFormula");
    if (phFormulaAuto && phFormulaAuto.dataset.manual !== "1"){
      const bruteTxt = (bruteFormulaTextEl.textContent || "").trim();
      if (bruteTxt && bruteTxt !== "—") phFormulaAuto.value = bruteTxt;
    }

    // détection acide fort / hydroxyde
    currentSpecies = detectStrongSpecies(expanded);

    // mettre à jour les valeurs de solution (C, T, n, pH, pOH)
    updateSolutionOutputs();
  }

  refreshDisplay();
  setMode("molar-mass");

  // écouteurs sur boutons
  const elemButtons = document.querySelectorAll(".elem-btn");
  elemButtons.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const sym = btn.dataset.sym;
      const mass = btn.dataset.mass;
      addAtom(sym, mass);
    });
  });

  // -------------------------
  // Onglet pH (acide/base forts)
  // -------------------------
  function countAcidProtons(formula){
    // Compte les H "détachables" de manière simple : H, H2, etc.
    // Ex: HCl -> 1 ; H2SO4 -> 2 ; CH3COOH -> (sera compté 4, mais ce modèle vise acides forts)
    const m = (formula || "").match(/H(\d*)/);
    if (!m) return 1;
    return m[1] ? parseInt(m[1], 10) : 1;
  }

  function countHydroxides(formula){
    // Reconnaît NaOH, Ca(OH)2, AlOH3, Al(OH)3
    const f = (formula || "").replace(/\s+/g, "");
    // (OH)2
    let m = f.match(/\(OH\)(\d+)/i);
    if (m) return parseInt(m[1], 10);
    // OH3
    m = f.match(/OH(\d+)/i);
    if (m) return parseInt(m[1], 10);
    // OH
    m = f.match(/OH/i);
    if (m) return 1;
    return 1;
  }


  function countHydrogens(formula){
    // Récupère le nombre de H "libérables" au début de la formule (acide fort type HCl, H2SO4, H3PO4).
    // On ne gère pas les cas complexes ; on suit ta règle : nombre de H au début.
    const f = (formula || "").trim().replace(/\s+/g, "");
    const m = f.match(/^H(\d+)/);
    if (m) return parseInt(m[1], 10);
    // Si ça commence par H sans chiffre : 1
    if (f.startsWith("H")) return 1;
    return 1;
  }

  function calcPHFromInputs(){
    const fEl = document.getElementById("phFormula");
    const cEl = document.getElementById("phConc");
    const phEl = document.getElementById("phGiven");
    const outPH = document.getElementById("phOut");

    if (!fEl || !outPH) return;

    const formulaRaw = (fEl.value || "").trim();
    const formula = formulaRaw.replace(/\s+/g, "");

    // Si on donne un pH : on calcule la concentration C (mol/L)
    const phGiven = phEl ? parseNumber(phEl.value) : NaN;
    if (isFinite(phGiven)){
      if (!formula){
        outPH.textContent = "—";
        return;
      }
      // [H+] = 10^-pH ; [OH-] = 10^(pH-14)
      if (/OH/i.test(formula)){
        const nOH = countHydroxides(formula);
        const OH = Math.pow(10, (phGiven - 14));
        const C = OH / nOH;
        outPH.textContent = format3Sig(C);
      } else if (formula.startsWith("H")){
        const nH = countHydrogens(formula);
        const H = Math.pow(10, -phGiven);
        const C = H / nH;
        outPH.textContent = format3Sig(C);
      } else {
        outPH.textContent = "—";
      }
      return;
    }

    // Sinon : on calcule le pH à partir de la concentration
    const C = cEl ? parseNumber(cEl.value) : NaN;
    if (!isFinite(C) || C <= 0 || !formula){
      outPH.textContent = "—";
      return;
    }

    if (/OH/i.test(formula)){
      const nOH = countHydroxides(formula);
      const OH = nOH * C;
      const pH = 14 + Math.log10(OH);
      outPH.textContent = format3Sig(pH);
    } else if (formula.startsWith("H")){
      const nH = countHydrogens(formula);
      const H = nH * C;
      const pH = -Math.log10(H);
      outPH.textContent = format3Sig(pH);
    } else {
      outPH.textContent = "—";
    }
  }
  // Si l'utilisateur tape dans la formule pH, on désactive l'auto-remplissage
  const phFormulaEl = document.getElementById("phFormula");
  if (phFormulaEl){
    phFormulaEl.addEventListener("input", ()=>{ phFormulaEl.dataset.manual = "1"; });
  }
const phCalcBtn = document.getElementById("phCalcBtn");
if (phCalcBtn){
    phCalcBtn.addEventListener("click", calcPHFromInputs);
  }


  /* TAB_FALLBACK : assure le fonctionnement des onglets même si une autre partie plante */
  (function(){
    function safeInitTabs(){
      try{
        const btns = document.querySelectorAll(".mode-btn");
        if (!btns || !btns.length) return;
        const sol = document.getElementById("solutionSection");
        const ph  = document.getElementById("phSection");
        function apply(mode){
          btns.forEach(b=>{
            const on = (b.dataset.mode === mode);
            b.classList.toggle("active", on);
            b.setAttribute("aria-selected", on ? "true" : "false");
          });
          if (sol) sol.classList.toggle("hidden", mode !== "solution");
          if (ph)  ph.classList.toggle("hidden", mode !== "ph");
        }
        btns.forEach(b=>{
          b.addEventListener("click", function(){
            apply(b.dataset.mode || "molar-mass");
          });
        });
      }catch(e){ /* ignore */ }
    }
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", safeInitTabs);
    }else{
      safeInitTabs();
    }
  })();
</script>
</body>
</html>
