<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loto chimie — Nom ➜ Formule</title>
<style>
  :root { --bg:#ffffff; --text:#0f172a; --muted:#475569; --accent:#0ea5e9; --good:#16a34a; --grid-border:#1f2937; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; margin:0; color:var(--text); background:#fff; line-height:1.35; }
  header { font-size:10px; padding:12px 16px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; background:#f1f5f9; gap:10px;  display:flex; justify-content:space-between; align-items:center; }
  .titles { display:flex; flex-direction:column; }
  .titles h1 { font-size:20px; margin:0; }
  .titles .subtitle { font-size:13px; color:var(--muted); margin-top:2px; }
  main { padding:12px; max-width:1300px; margin:0 auto; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button, select { border:1px solid #e5e7eb; background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
  button.primary { background: var(--accent); border-color: var(--accent); color:#fff; }
  label.inline { display:flex; gap:6px; align-items:center; font-weight:600; }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  .grow { flex:1 1 420px; }
  .card { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
  .current-call .call { font-size: 26px; font-weight:800; }
  .small { font-size:12px; color: var(--muted); }
  .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#e2e8f0; color:#0f172a; }
  .timer { font-weight:800; }
  .timer.warn { color: #f59e0b; }
  .timer.danger { color: #ef4444; }
  .layout { display:grid; grid-template-columns: 260px 1fr; gap:12px; }
  .selector { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
  .selector h3 { margin:0 0 8px 0; font-size:14px; }
  .selector .grid-list { display:grid; grid-template-columns: repeat(5, 1fr); gap:6px; max-height: 300px; overflow:auto; }
  .selector .grid-list label { display:flex; gap:6px; align-items:center; font-size:12px; padding:4px; border-radius:8px; background:#f8fafc; border:1px solid #e5e7eb; }
  .selector .actions { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  .selector input[type="text"] { width:100%; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; }
  .grids { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:10px; margin-top:8px; }
  .grid-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:8px; position: relative; }
  .grid-title { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .grid { display:grid; grid-template-columns: repeat(3, 1fr); border: 2px solid var(--grid-border); border-radius:8px; overflow:hidden; }
  .cell { position:relative; display:flex; align-items:center; justify-content:center; text-align:center; font-weight:800;
           border-right:1px solid #94a3b8; border-bottom:1px solid #94a3b8; background:#fff; aspect-ratio:1/1; padding:6px; }
  .cell:nth-child(3n) { border-right: none; }
  .cell:nth-last-child(-n+3) { border-bottom: none; }
  .cell > span { display:inline-block; white-space:nowrap; font-size: 8px; line-height:1; }
  .cell sub { font-size: 0.7em; line-height: 0; vertical-align: sub; }
  .marked { background:#dcfce7; transition: background .25s ease; }
  .linewin { background:#bbf7d0 !important; }
  .winner-banner { position:absolute; left:50%; top:6px; transform:translateX(-50%); background:#16a34a; color:#fff; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:800; }
  .hidden { display:none; }
  .empty-note { padding:20px; text-align:center; color:#64748b; border:1px dashed #cbd5e1; border-radius:12px; background:#fff; }
  .toggle-area { display:flex; gap:10px; align-items:center; }

  .program-info { border:1px solid #94a3b8; border-radius:8px; padding:6px 10px; font-size: 10px; background:#fff; color:#0f172a; text-align:right; line-height:1.2;  margin-left:auto; text-align:right; }


/* === Familles (filtres + badge) === */
.families-wrap { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.fam-filters { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.fam-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; font-size:12px; }
.fam-chip input { transform: translateY(1px); }
.badge-family { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; font-size:12px; background:#e2e8f0; color:#0f172a; }


/* === Affichage on/off des familles === */
.families-toggle { display:flex; align-items:center; }
.hidden { display:none !important; }

</style>
</head>
<body>
  <header>
    <div class="titles">
      <h1>Loto chimie</h1>
      <div class="subtitle">Nom ➜ Formule</div>
    </div>
    <div class="controls">
      <button class="primary" id="draw">Tirer un nom</button>
      <button id="revealNow">Révéler maintenant</button>
      <button id="undo">Annuler</button>
      <button id="reset">Réinitialiser</button>
      <label class="inline">Durée
        <select id="timerSeconds">
          <option value="0">0 s</option>
          <option value="5">5 s</option>
          <option value="7">7 s</option>
          <option value="10">10 s</option>
          <option value="20">20 s</option>
          <option value="30" selected>30 s</option>
          <option value="45">45 s</option>
          <option value="60">60 s</option>
        </select>
      </label>
      <label class="inline">Seuil révélation
        <select id="revealAt">
          <option value="none" selected>Pas de révélation</option>
          <option value="end">À la fin</option>
          <option value="5">5 s</option>
          <option value="8">8 s</option>
          <option value="10">10 s</option>
        </select>
      </label>
      <label class="toggle-area"><input type="checkbox" id="muteBeep"> Mute bip</label>
      <label class="toggle-area"><input type="checkbox" id="showGrids" checked> Afficher les grilles</label>
      <label class="toggle-area"><input type="checkbox" id="showSelector" checked> Afficher la zone de sélection</label>
    
    <div class="families-wrap">
      <span class="small" style="font-weight:700;">Familles :</span>
      <div id="familyFilters" class="fam-filters"></div>
      
      
    </div>

    <div class="families-toggle">
      <label class="inline"><input type="checkbox" id="toggleFam"> Afficher la famille</label>
    </div>

    <div class="program-info"><strong>Version 1.2</strong><br/>S. Ulrich<br/>ECG Henry-Dunant</div>

</header>
  <main>
    <div class="row">
      <section class="grow card current-call">
        <h2 style="margin-top:0;">Tirage</h2>
        <div id="current" class="call small">Aucun tirage pour l'instant</div>
        <div class="small">⏱️ <span id="timer" class="timer">—</span></div>
      </section>
      <section class="card grow">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <h2 style="margin:0;">Historique</h2>
          <span id="drawCount" class="badge">0 / <span id="poolSize">0</span></span>
        </div>
        <div class="history"><ul id="history"></ul></div>
      </section>
    </div>

    <div class="layout" style="margin-top:12px;">
      <aside class="selector">
        <h3>Afficher seulement les grilles cochées</h3>
        <div class="grid-list" id="gridList"></div>
        <div class="actions">
          <button id="selectAll">Tout</button>
          <button id="selectNone">Aucune</button>
          <button id="applySel" class="primary">Appliquer</button>
        </div>
        <div class="small" style="margin-top:8px;">Coller une liste (ex: 1,2,5-10)</div>
        <input type="text" id="preset" placeholder="Ex: 1,2,5-10" />
        <div class="actions">
          <button id="loadPreset">Charger</button>
          <button id="saveSel">Sauvegarder la sélection</button>
        </div>
        <div class="small" id="selInfo" style="margin-top:6px;"></div>
      </aside>

      <section class="card" id="gridContainer">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div class="grid-title"><h2 style="margin:0;">Grilles (FORMULES) — 3×3</h2><div id="validator" class="small"></div></div>
          <div class="small" id="visCount"></div>
        </div>
        <div id="grids" class="grids"></div>
        <div id="emptyNote" class="hidden empty-note">Coche des grilles dans le panneau de gauche pour les afficher ici.</div>
      </section>
    </div>
  </main>

<script>
let REVEAL_MODE = "none"; // "none" | "end" | number (5/8/10)
let forceReveal = false;
const DATA = [{"formula": "H2", "name": "Dihydrogène", "family": "Corps simples"}, {"formula": "Na2O", "name": "Oxyde de sodium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "K2O", "name": "Oxyde de potassium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "CaO", "name": "Oxyde de calcium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "MgO", "name": "Oxyde de magnésium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Al2O3", "name": "Oxyde d’aluminium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "ZnO", "name": "Oxyde de zinc", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "FeO", "name": "Oxyde de fer(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Fe2O3", "name": "Oxyde de fer(III)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Cu2O", "name": "Oxyde de cuivre(I)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "CuO", "name": "Oxyde de cuivre(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "PbO", "name": "Oxyde de plomb(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "PbO2", "name": "Oxyde de plomb(IV)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "SnO", "name": "Oxyde d’étain(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "SnO2", "name": "Oxyde d’étain(IV)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Cr2O3", "name": "Oxyde de chrome(III)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "MnO", "name": "Oxyde de manganèse(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "MnO2", "name": "Oxyde de manganèse(IV)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "CoO", "name": "Oxyde de cobalt(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Co2O3", "name": "Oxyde de cobalt(III)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "NiO", "name": "Oxyde de nickel(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Ag2O", "name": "Oxyde d’argent", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "BaO", "name": "Oxyde de baryum", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "SrO", "name": "Oxyde de strontium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "Li2O", "name": "Oxyde de lithium", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "HgO", "name": "Oxyde de mercure(II)", "family": "Oxydes de métaux ou oxydes d’éléments de transition"}, {"formula": "CO", "name": "Monoxyde de carbone", "family": "Oxydes de non-métaux"}, {"formula": "CO2", "name": "Dioxyde de carbone", "family": "Oxydes de non-métaux"}, {"formula": "SO2", "name": "Dioxyde de soufre", "family": "Oxydes de non-métaux"}, {"formula": "SO3", "name": "Trioxyde de soufre", "family": "Oxydes de non-métaux"}, {"formula": "NO2", "name": "Dioxyde d’azote", "family": "Oxydes de non-métaux"}, {"formula": "N2O3", "name": "Trioxyde de diazote", "family": "Oxydes de non-métaux"}, {"formula": "N2O5", "name": "Pentoxyde de diazote", "family": "Oxydes de non-métaux"}, {"formula": "P2O3", "name": "Trioxyde de diphosphore", "family": "Oxydes de non-métaux"}, {"formula": "P2O5", "name": "Pentoxyde de diphosphore", "family": "Oxydes de non-métaux"}, {"formula": "Cl2O", "name": "Monoxyde de dichlore", "family": "Oxydes de non-métaux"}, {"formula": "Cl2O7", "name": "Heptoxyde de dichlore", "family": "Oxydes de non-métaux"}, {"formula": "SiO2", "name": "Dioxyde de silicium", "family": "Oxydes de non-métaux"}, {"formula": "B2O3", "name": "Trioxyde de dibore", "family": "Oxydes de non-métaux"}, {"formula": "As2O3", "name": "Trioxyde de diarsenic", "family": "Oxydes de non-métaux"}, {"formula": "As2O5", "name": "Pentoxyde de diarsenic", "family": "Oxydes de non-métaux"}, {"formula": "SeO2", "name": "Dioxyde de sélénium", "family": "Oxydes de non-métaux"}, {"formula": "SeO3", "name": "Trioxyde de sélénium", "family": "Oxydes de non-métaux"}, {"formula": "TeO2", "name": "Dioxyde de tellure", "family": "Oxydes de non-métaux"}, {"formula": "I2O5", "name": "Pentoxyde de diiode", "family": "Oxydes de non-métaux"}, {"formula": "Br2O", "name": "Monoxyde de dibrome", "family": "Oxydes de non-métaux"}, {"formula": "ClO2", "name": "Dioxyde de chlore", "family": "Oxydes de non-métaux"}, {"formula": "NaOH", "name": "Hydroxyde de sodium", "family": "Hydroxydes"}, {"formula": "KOH", "name": "Hydroxyde de potassium", "family": "Hydroxydes"}, {"formula": "Ca(OH)2", "name": "Hydroxyde de calcium", "family": "Hydroxydes"}, {"formula": "Mg(OH)2", "name": "Hydroxyde de magnésium", "family": "Hydroxydes"}, {"formula": "Al(OH)3", "name": "Hydroxyde d’aluminium", "family": "Hydroxydes"}, {"formula": "Fe(OH)2", "name": "Hydroxyde de fer(II)", "family": "Hydroxydes"}, {"formula": "Fe(OH)3", "name": "Hydroxyde de fer(III)", "family": "Hydroxydes"}, {"formula": "Cu(OH)2", "name": "Hydroxyde de cuivre(II)", "family": "Hydroxydes"}, {"formula": "Zn(OH)2", "name": "Hydroxyde de zinc", "family": "Hydroxydes"}, {"formula": "Pb(OH)2", "name": "Hydroxyde de plomb(II)", "family": "Hydroxydes"}, {"formula": "Sn(OH)2", "name": "Hydroxyde d’étain(II)", "family": "Hydroxydes"}, {"formula": "Cr(OH)3", "name": "Hydroxyde de chrome(III)", "family": "Hydroxydes"}, {"formula": "Ni(OH)2", "name": "Hydroxyde de nickel(II)", "family": "Hydroxydes"}, {"formula": "Co(OH)2", "name": "Hydroxyde de cobalt(II)", "family": "Hydroxydes"}, {"formula": "Ba(OH)2", "name": "Hydroxyde de baryum", "family": "Hydroxydes"}, {"formula": "HF", "name": "Acide fluorhydrique", "family": "Hydracides"}, {"formula": "HCl", "name": "Acide chlorhydrique", "family": "Hydracides"}, {"formula": "HBr", "name": "Acide bromhydrique", "family": "Hydracides"}, {"formula": "HI", "name": "Acide iodhydrique", "family": "Hydracides"}, {"formula": "H2S", "name": "Acide sulfhydrique", "family": "Hydracides"}, {"formula": "H2Se", "name": "Acide sélénhydrique", "family": "Hydracides"}, {"formula": "H2Te", "name": "Acide tellurhydrique", "family": "Hydracides"}, {"formula": "H2SO4", "name": "Acide sulfurique", "family": "Oxacides"}, {"formula": "H2SO3", "name": "Acide sulfureux", "family": "Oxacides"}, {"formula": "HNO3", "name": "Acide nitrique", "family": "Oxacides"}, {"formula": "HNO2", "name": "Acide nitreux", "family": "Oxacides"}, {"formula": "H3PO4", "name": "Acide phosphorique", "family": "Oxacides"}, {"formula": "H3PO3", "name": "Acide phosphoreux", "family": "Oxacides"}, {"formula": "H2CO3", "name": "Acide carbonique", "family": "Oxacides"}, {"formula": "H2CrO4", "name": "Acide chromique", "family": "Oxacides"}, {"formula": "NaCl", "name": "Chlorure de sodium", "family": "Sels sans oxygène"}, {"formula": "KBr", "name": "Bromure de potassium", "family": "Sels sans oxygène"}, {"formula": "CaCl2", "name": "Chlorure de calcium", "family": "Sels sans oxygène"}, {"formula": "MgCl2", "name": "Chlorure de magnésium", "family": "Sels sans oxygène"}, {"formula": "AlCl3", "name": "Chlorure d’aluminium", "family": "Sels sans oxygène"}, {"formula": "ZnCl2", "name": "Chlorure de zinc", "family": "Sels sans oxygène"}, {"formula": "FeCl2", "name": "Chlorure de fer(II)", "family": "Sels sans oxygène"}, {"formula": "FeCl3", "name": "Chlorure de fer(III)", "family": "Sels sans oxygène"}, {"formula": "CuCl", "name": "Chlorure de cuivre(I)", "family": "Sels sans oxygène"}, {"formula": "CuCl2", "name": "Chlorure de cuivre(II)", "family": "Sels sans oxygène"}, {"formula": "PbCl2", "name": "Chlorure de plomb(II)", "family": "Sels sans oxygène"}, {"formula": "AgCl", "name": "Chlorure d’argent", "family": "Sels sans oxygène"}, {"formula": "NaI", "name": "Iodure de sodium", "family": "Sels sans oxygène"}, {"formula": "KI", "name": "Iodure de potassium", "family": "Sels sans oxygène"}, {"formula": "CaBr2", "name": "Bromure de calcium", "family": "Sels sans oxygène"}, {"formula": "Na2SO4", "name": "Sulfate de sodium", "family": "Sels avec oxygène"}, {"formula": "K2SO4", "name": "Sulfate de potassium", "family": "Sels avec oxygène"}, {"formula": "CaSO4", "name": "Sulfate de calcium", "family": "Sels avec oxygène"}, {"formula": "MgSO4", "name": "Sulfate de magnésium", "family": "Sels avec oxygène"}, {"formula": "BaSO4", "name": "Sulfate de baryum", "family": "Sels avec oxygène"}, {"formula": "Al2(SO4)3", "name": "Sulfate d’aluminium", "family": "Sels avec oxygène"}, {"formula": "FeSO4", "name": "Sulfate de fer(II)", "family": "Sels avec oxygène"}, {"formula": "Fe2(SO4)3", "name": "Sulfate de fer(III)", "family": "Sels avec oxygène"}, {"formula": "CuSO4", "name": "Sulfate de cuivre(II)", "family": "Sels avec oxygène"}, {"formula": "ZnSO4", "name": "Sulfate de zinc", "family": "Sels avec oxygène"}, {"formula": "NaNO3", "name": "Nitrate de sodium", "family": "Sels avec oxygène"}, {"formula": "KNO3", "name": "Nitrate de potassium", "family": "Sels avec oxygène"}, {"formula": "Ca(NO3)2", "name": "Nitrate de calcium", "family": "Sels avec oxygène"}, {"formula": "AgNO3", "name": "Nitrate d’argent", "family": "Sels avec oxygène"}, {"formula": "Pb(NO3)2", "name": "Nitrate de plomb(II)", "family": "Sels avec oxygène"}, {"formula": "O2", "name": "Dioxygène", "family": "Corps simples"}, {"formula": "N2", "name": "Diazote", "family": "Corps simples"}, {"formula": "CH3COOH", "name": "Acide acétique", "family": "Oxacides"}, {"formula": "CH3COONa", "name": "Acétate de sodium", "family": "Sels avec oxygène"}, {"formula": "Mg(CH3COO)2", "name": "Acétate de magnésium", "family": "Sels avec oxygène"}];
const GRIDS = [["MgSO4", "Ag2O", "Ni(OH)2", "H2Te", "CaBr2", "Li2O", "CuCl2", "K2SO4", "O2"], ["Cu(OH)2", "Co2O3", "I2O5", "ZnO", "SnO", "HI", "Mg(OH)2", "Na2SO4", "CH3COONa"], ["As2O5", "H2Te", "Mg(OH)2", "P2O3", "H2Se", "HNO3", "CaO", "PbO", "SO3"], ["K2O", "PbCl2", "CaBr2", "Sn(OH)2", "CoO", "Cu2O", "HgO", "MnO2", "Fe(OH)2"], ["KBr", "Cl2O", "KI", "Fe2(SO4)3", "CaO", "Br2O", "BaSO4", "Pb(OH)2", "H2S"], ["Al2O3", "ZnO", "Ca(NO3)2", "Na2SO4", "PbCl2", "Fe2O3", "Zn(OH)2", "P2O5", "Cu2O"], ["Co(OH)2", "CuCl2", "ClO2", "Mg(OH)2", "SeO3", "N2", "SnO", "CuCl", "Al2(SO4)3"], ["HgO", "Li2O", "CaBr2", "CaO", "Cr(OH)3", "H2", "FeO", "Fe2O3", "K2SO4"], ["CH3COONa", "ClO2", "CuSO4", "Fe(OH)3", "MgSO4", "MgCl2", "As2O5", "H2", "Fe(OH)2"], ["K2O", "H2CO3", "P2O3", "CaBr2", "Na2O", "Pb(OH)2", "Fe2O3", "MnO", "Cu2O"], ["FeCl2", "N2O5", "KI", "KNO3", "P2O5", "B2O3", "Co(OH)2", "PbCl2", "SnO2"], ["H2SO4", "SO3", "MgSO4", "Na2O", "NiO", "HNO3", "AgNO3", "Al2(SO4)3", "Cl2O"], ["AgCl", "MnO2", "As2O5", "MgO", "Ba(OH)2", "K2SO4", "H2", "SO3", "K2O"], ["CaSO4", "PbO", "O2", "Cl2O7", "CO2", "Ba(OH)2", "PbCl2", "Ca(NO3)2", "Cl2O"], ["KNO3", "KBr", "ZnO", "H2CrO4", "I2O5", "FeCl2", "N2", "K2O", "AgNO3"], ["HNO3", "CuCl", "SnO2", "H2CO3", "Li2O", "K2SO4", "CuO", "MgCl2", "Ba(OH)2"], ["As2O3", "Ca(OH)2", "ClO2", "SO2", "MgCl2", "P2O3", "K2O", "NaI", "H2S"], ["CH3COOH", "FeCl3", "CaCl2", "H2SO3", "CuCl", "Ca(NO3)2", "ClO2", "Ba(OH)2", "ZnCl2"], ["MnO2", "SeO2", "Fe2O3", "Na2O", "NaI", "H2CrO4", "Fe2(SO4)3", "CaSO4", "Pb(OH)2"], ["SeO2", "AlCl3", "HF", "N2", "CH3COONa", "CuCl2", "Zn(OH)2", "SrO", "Ag2O"], ["SnO2", "H2Te", "KNO3", "SO2", "ZnSO4", "Ag2O", "CaO", "SeO3", "H2"], ["SeO3", "NaI", "Li2O", "SO2", "CuSO4", "H3PO3", "O2", "SiO2", "SnO"], ["MnO2", "N2O5", "SO2", "As2O5", "Co2O3", "Na2O", "CaSO4", "HNO3", "K2O"], ["Cu(OH)2", "H2S", "AgCl", "Cr(OH)3", "CaO", "MgSO4", "Li2O", "AlCl3", "Na2O"], ["P2O3", "Al2O3", "N2O3", "SrO", "P2O5", "SnO2", "Na2O", "H2SO3", "NaI"], ["As2O5", "Fe2O3", "PbCl2", "H3PO3", "Ni(OH)2", "HNO2", "CO", "CuCl", "Fe(OH)3"], ["ZnO", "KBr", "NaNO3", "MgO", "Cr2O3", "ClO2", "As2O5", "N2", "NaI"], ["AgNO3", "Zn(OH)2", "Co2O3", "Ag2O", "MnO2", "ZnCl2", "O2", "Ni(OH)2", "CO2"], ["HNO3", "CaSO4", "ZnO", "PbO2", "H2SO3", "AgNO3", "Cl2O", "MgO", "MgCl2"], ["NaI", "SnO2", "Cu(OH)2", "CO2", "Ni(OH)2", "Li2O", "KNO3", "CuSO4", "KI"], ["Al(OH)3", "HBr", "MnO", "ZnSO4", "Al2O3", "Mg(CH3COO)2", "Fe2O3", "CuCl", "Cu2O"], ["P2O5", "H2CO3", "HF", "AgNO3", "PbO2", "Co(OH)2", "Al2(SO4)3", "CaBr2", "Sn(OH)2"], ["Cr(OH)3", "N2", "B2O3", "MgCl2", "NiO", "FeO", "Cu2O", "Mg(CH3COO)2", "H3PO3"], ["Na2O", "KBr", "CuCl2", "I2O5", "FeO", "CH3COOH", "B2O3", "Co(OH)2", "MnO"], ["Ca(NO3)2", "Ba(OH)2", "SrO", "H2S", "Ni(OH)2", "Al2(SO4)3", "ZnCl2", "Ag2O", "HF"], ["SeO3", "BaSO4", "Co2O3", "HNO3", "FeO", "Cl2O7", "CH3COONa", "Al2(SO4)3", "CH3COOH"], ["H2S", "I2O5", "H3PO3", "AgNO3", "Cu2O", "Fe(OH)2", "H3PO4", "SrO", "O2"], ["Fe2O3", "Cr(OH)3", "Al(OH)3", "AgNO3", "KOH", "FeO", "I2O5", "SnO", "SeO2"], ["CaSO4", "SO3", "SeO2", "HgO", "CuSO4", "NaOH", "TeO2", "As2O3", "Cu(OH)2"], ["CuSO4", "N2O3", "SiO2", "KNO3", "Fe(OH)3", "Cu(OH)2", "H2", "CuO", "Fe(OH)2"], ["CuCl", "AgNO3", "NaNO3", "FeO", "Ni(OH)2", "KNO3", "NaCl", "KI", "HBr"], ["CaCl2", "Al2O3", "FeCl2", "As2O3", "Cl2O7", "HgO", "CH3COONa", "Al2(SO4)3", "HNO2"], ["CO2", "Ag2O", "FeO", "ClO2", "HBr", "Sn(OH)2", "MgSO4", "SnO2", "Fe2O3"], ["NaOH", "Ba(OH)2", "Na2SO4", "BaSO4", "MgSO4", "KBr", "CaCl2", "HNO3", "KI"], ["CuCl", "As2O3", "MgSO4", "CH3COONa", "SnO2", "Na2O", "Ca(OH)2", "P2O5", "CuSO4"], ["PbO", "P2O3", "Cl2O", "Ca(NO3)2", "HNO2", "H2S", "As2O3", "SeO3", "Mg(OH)2"], ["MnO", "CO2", "KBr", "H3PO4", "SnO2", "AgCl", "CuCl2", "KNO3", "CH3COOH"], ["MgO", "SO2", "NaNO3", "NaCl", "NaOH", "Co2O3", "HgO", "H2CrO4", "CoO"], ["FeCl2", "B2O3", "SnO2", "SrO", "CaSO4", "Al2O3", "Co2O3", "CoO", "Mg(CH3COO)2"], ["Ca(OH)2", "N2", "AlCl3", "HI", "Co2O3", "Li2O", "FeO", "AgCl", "NaCl"]];
document.getElementById("poolSize").textContent = DATA.length;

function fmtFormula(s) { return s.replace(/([0-9]+)/g, "<sub>$1</sub>"); }
const byName = new Map(DATA.map(x => [x.name, x.formula]));
const byFormula = new Map(DATA.map(x => [x.formula, x.name]));


// === Gestion des familles (UI + filtre) ===
const LS_KEY_FAM = "N2F_FAMILIES_V1";

function getAllFamilies() {
  return Array.from(new Set(DATA.map(x => x.family))).sort((a,b)=>a.localeCompare(b,'fr'));
}
function getSavedFamilies() {
  try { const raw = localStorage.getItem(LS_KEY_FAM); if (!raw) return null; const arr = JSON.parse(raw); if (Array.isArray(arr) && arr.length) return new Set(arr); } catch(e){}
  return null;
}
function saveFamilies(set) { localStorage.setItem(LS_KEY_FAM, JSON.stringify(Array.from(set))); }
function buildFamilyFilters() {
  updateFamiliesPanelVisibility();
  const host = document.getElementById("familyFilters"); if (!host) return;
  host.innerHTML = "";
  const all = getAllFamilies();
  const saved = getSavedFamilies();
  const active = saved ?? new Set(all);
  all.forEach(fam => {
    const label = document.createElement("label"); label.className = "fam-chip";
    const cb = document.createElement("input"); cb.type = "checkbox"; cb.value = fam; cb.checked = active.has(fam);
    cb.addEventListener("change", () => { if (cb.checked) active.add(fam); else active.delete(fam); saveFamilies(active); if (typeof updateUI === "function") updateUI(); });
    const span = document.createElement("span"); span.textContent = fam;
    label.appendChild(cb); label.appendChild(span); host.appendChild(label);
  });
  const btnAll = document.getElementById("famAll"); const btnNone = document.getElementById("famNone");
  if (btnAll) btnAll.onclick = ()=>{ const setAll=new Set(getAllFamilies()); saveFamilies(setAll); buildFamilyFilters(); if (typeof updateUI === "function") updateUI(); };
  if (btnNone) btnNone.onclick = ()=>{ saveFamilies(new Set()); buildFamilyFilters(); if (typeof updateUI === "function") updateUI(); };
}
function getActiveFamilies() { const saved = getSavedFamilies(); return saved ?? new Set(getAllFamilies()); }
function isFamilyActive(family) { return getActiveFamilies().has(family); }
function recordByName(name) { return DATA.find(x=>x.name===name); }
function recordByFormula(formula) { return DATA.find(x=>x.formula===formula); }

// Construire les filtres au chargement
document.addEventListener("DOMContentLoaded", ()=>{ try { buildFamilyFilters(); } catch(e){} updateFamiliesPanelVisibility(); });



// === Affichage on/off de la famille (badge) ===
const LS_KEY_SHOW_FAM = "N2F_SHOW_FAMILY_V1";
function getShowFamily(){
  try { const v = localStorage.getItem(LS_KEY_SHOW_FAM); if (v===null) return true; return v === "1"; } catch(e){ return true; }
}
function saveShowFamily(flag){
  try { localStorage.setItem(LS_KEY_SHOW_FAM, flag ? "1" : "0"); } catch(e){}
}
function wireShowFamilyToggle(){
  const cb = document.getElementById("toggleFam");
  if (!cb) return;
  cb.checked = getShowFamily();
  updateFamiliesPanelVisibility();
  cb.addEventListener("change", ()=>{
    saveShowFamily(cb.checked);
    updateFamiliesPanelVisibility();
    if (typeof updateUI === "function") updateUI();
  });
}

document.addEventListener("DOMContentLoaded", wireShowFamilyToggle);



// === Masquer/Afficher le panneau des familles selon le toggle ===
function updateFamiliesPanelVisibility(){
  try {
    const wrap = document.querySelector('.families-wrap');
    if (!wrap) return;
    wrap.classList.toggle('hidden', !getShowFamily());
  } catch(e){}
}

// Validation
const elValidator = document.getElementById("validator");
(function validate(){ const ok = GRIDS.length===50 && GRIDS.every(g => Array.isArray(g) && g.length===9);
  elValidator.textContent = ok ? "✅ 50 grilles × 9 cases (3×3)" : "❌ Problème de structure"; 
  elValidator.style.color = ok ? "#16a34a" : "#ef4444"; })();

// Index
let INDEX = new Map();
(function rebuildIndex(){
  INDEX = new Map();
  GRIDS.forEach((grid,gid)=>{
    grid.forEach((f,i)=>{ if(!INDEX.has(f)) INDEX.set(f,[]); INDEX.get(f).push({grid:gid,row:Math.floor(i/3),col:i%3}); });
  });
})();

// État
let drawn = [];
let marks = Array.from({length:50}, ()=>Array(9).fill(false));

// Audio
let audioCtx = null; let isMuted = false;
function ensureAudioCtx() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { audioCtx = null; } } else if (audioCtx.state === "suspended") audioCtx.resume(); }
function playBeep() { if (!audioCtx || isMuted) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.15); o.start(); o.stop(audioCtx.currentTime+0.15); }
document.body.addEventListener("click", ensureAudioCtx, { once:true });

// Contrôles
const timerSelect = document.getElementById("timerSeconds");
const revealSelect = document.getElementById("revealAt");
const muteCb = document.getElementById("muteBeep");
const showGridsCb = document.getElementById("showGrids");
const gridContainer = document.getElementById("gridContainer");
document.getElementById("revealNow").addEventListener("click", ()=>{ forceReveal = true; refreshRevealVisibility(); });

// Storage keys
const KEY = "N2F_ZERO";
function LS(k){ return KEY+"_"+k; }

// Charger préférences
const savedDur = localStorage.getItem(LS("timerSeconds"));
if (savedDur && timerSelect.querySelector(`option[value="${savedDur}"]`)) timerSelect.value = savedDur;
const savedReveal = localStorage.getItem(LS("revealAt"));
if (savedReveal) { revealSelect.value = savedReveal; REVEAL_MODE = savedReveal==="none" ? "none" : (savedReveal==="end" ? "end" : parseInt(savedReveal,10)); }
const savedMute = localStorage.getItem(LS("muteBeep"));
if (savedMute !== null) { muteCb.checked = savedMute === "true"; isMuted = muteCb.checked; }
const savedVis = localStorage.getItem(LS("showGrids"));
if (savedVis !== null) showGridsCb.checked = savedVis === "true";
applyGridVisibility();

timerSelect.addEventListener("change", ()=> localStorage.setItem(LS("timerSeconds"), timerSelect.value));
revealSelect.addEventListener("change", ()=>{ 
  localStorage.setItem(LS("revealAt"), revealSelect.value); 
  REVEAL_MODE = revealSelect.value==="none" ? "none" : (revealSelect.value==="end" ? "end" : parseInt(revealSelect.value,10));
  forceReveal=false; refreshRevealVisibility(); 
});
muteCb.addEventListener("change", ()=>{ isMuted = muteCb.checked; localStorage.setItem(LS("muteBeep"), muteCb.checked ? "true":"false"); });
showGridsCb.addEventListener("change", ()=>{ applyGridVisibility(); localStorage.setItem(LS("showGrids"), showGridsCb.checked ? "true" : "false"); });

function applyGridVisibility(){ gridContainer.style.display = showGridsCb.checked ? "" : "none"; }

// Timer
let timerId = null; let remaining = null;
const elTimer = document.getElementById("timer");
function updateTimerUI() { 
  if (remaining === null) { elTimer.textContent = "—"; elTimer.className = "timer"; return; } 
  elTimer.textContent = remaining + " s restantes"; elTimer.className = "timer"; 
  if (remaining <= 10 && remaining > 5) elTimer.classList.add("warn"); 
  if (remaining <= 5) elTimer.classList.add("danger"); 
  refreshRevealVisibility(); 
}
function stopTimer() { if (timerId !== null) { clearInterval(timerId); timerId = null; } remaining = null; updateTimerUI(); }
function startTimer(seconds) { 
  stopTimer(); remaining = seconds; updateTimerUI(); 
  if (seconds <= 0) {
    // Timer désactivé : révélation immédiate si mode "end" ou numérique, sinon rien
    if (REVEAL_MODE === "end" || (typeof REVEAL_MODE === "number")) { forceReveal = true; refreshRevealVisibility(); }
    return;
  }
  timerId = setInterval(() => { 
    remaining -= 1; 
    if (remaining <= 0) { 
      remaining = 0; updateTimerUI(); playBeep(); 
      if (REVEAL_MODE === "end") { forceReveal = true; refreshRevealVisibility(); }
      stopTimer(); return; 
    } 
    updateTimerUI(); 
  }, 1000); 
}

// Sélecteur
const gridList = document.getElementById("gridList");
const visCount = document.getElementById("visCount");
const emptyNote = document.getElementById("emptyNote");
const selInfo = document.getElementById("selInfo");

function buildSelector() {
  gridList.innerHTML = "";
  for (let i=1;i<=50;i++) {
    const label = document.createElement("label");
    const cb = document.createElement("input");
    cb.type = "checkbox"; cb.dataset.gid = (i-1);
    label.appendChild(cb);
    const span = document.createElement("span"); span.textContent = i;
    label.appendChild(span);
    gridList.appendChild(label);
  }
  const saved = localStorage.getItem(LS("selectedGrids"));
  if (saved) {
    try { JSON.parse(saved).forEach(gid => { const cb = gridList.querySelector(`input[data-gid="${gid}"]`); if (cb) cb.checked = true; }); } catch {}
  } else {
    [0,1,2,3,4,5].forEach(gid=>{ const cb = gridList.querySelector(`input[data-gid="${gid}"]`); if (cb) cb.checked = true; });
  }
  updateSelInfo();
}
function parsePreset(s) {
  const out = new Set();
  s.split(",").map(x=>x.trim()).filter(Boolean).forEach(part=>{
    if (part.includes("-")) {
      const [a,b] = part.split("-").map(v=>parseInt(v,10));
      if (!isNaN(a) && !isNaN(b)) for (let k=Math.min(a,b); k<=Math.max(a,b); k++) if (k>=1 && k<=50) out.add(k-1);
    } else {
      const n = parseInt(part,10);
      if (!isNaN(n) && n>=1 && n<=50) out.add(n-1);
    }
  });
  return Array.from(out).sort((a,b)=>a-b);
}
function getSelection() {
  const arr = [];
  gridList.querySelectorAll("input[type=checkbox]").forEach(cb=>{ if (cb.checked) arr.push(parseInt(cb.dataset.gid,10)); });
  return arr.sort((a,b)=>a-b);
}
function setSelection(arr) {
  gridList.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=false);
  arr.forEach(gid=>{ const cb = gridList.querySelector(`input[data-gid="${gid}"]`); if (cb) cb.checked = true; });
  updateSelInfo();
}
function updateSelInfo() {
  const arr = getSelection();
  selInfo.textContent = arr.length ? `Sélection: ${arr.map(x=>x+1).join(", ")}` : "Aucune sélection";
}

document.getElementById("selectAll").addEventListener("click", ()=> setSelection(Array.from({length:50}, (_,i)=>i)) );
document.getElementById("selectNone").addEventListener("click", ()=> setSelection([]) );
document.getElementById("loadPreset").addEventListener("click", ()=>{ const s = document.getElementById("preset").value || ""; setSelection(parsePreset(s)); });
document.getElementById("saveSel").addEventListener("click", ()=>{ localStorage.setItem(LS("selectedGrids"), JSON.stringify(getSelection())); updateSelInfo(); });
document.getElementById("applySel").addEventListener("click", ()=>{ renderGrids(); localStorage.setItem(LS("selectedGrids"), JSON.stringify(getSelection())); });


// === Option: afficher / masquer la zone de sélection (le carré de gauche) ===
const LS_SHOW_SELECTOR = "SHOW_SELECTOR_V1";
function getShowSelector(){
  try { const v = localStorage.getItem(LS_SHOW_SELECTOR); return v !== "0"; } catch(e){ return true; }
}
function saveShowSelector(flag){
  try { localStorage.setItem(LS_SHOW_SELECTOR, flag ? "1" : "0"); } catch(e){}
}
function applySelectorVisibility(){
  const sel = document.querySelector("aside.selector");
  if (!sel) return;
  sel.style.display = getShowSelector() ? "" : "none";
}
function wireShowSelectorToggle(){
  const cb = document.getElementById("showSelector");
  if (!cb) return;
  cb.checked = getShowSelector();
  cb.addEventListener("change", ()=>{
    saveShowSelector(cb.checked);
    applySelectorVisibility();
  });
}
document.addEventListener("DOMContentLoaded", ()=>{
  wireShowSelectorToggle();
  applySelectorVisibility();
});

// Rendu
const elCurrent = document.getElementById("current");
const elHistory = document.getElementById("history");
const elDrawCount = document.getElementById("drawCount");
const elGrids = document.getElementById("grids");

function renderGrids(){
  const selection = getSelection();
  elGrids.innerHTML = "";
  if (selection.length === 0) {
    emptyNote.classList.remove("hidden");
    visCount.textContent = "0 affichée";
  } else {
    emptyNote.classList.add("hidden");
    selection.forEach(gid=>{
      const grid = GRIDS[gid];
      const card = document.createElement("div");
      card.className = "grid-card";
      card.dataset.gid = gid;
      card.innerHTML = `<div class="grid-title"><div>Grille ${gid+1}</div><div class="small">3×3</div></div>`;
      const g = document.createElement("div"); g.className = "grid";
      grid.forEach((f,i)=>{ const cell=document.createElement('div'); cell.className='cell'; cell.dataset.gid=gid; cell.dataset.idx=i; const span=document.createElement('span'); span.innerHTML = fmtFormula(f); cell.appendChild(span); cell.addEventListener('click', ()=>{ marks[gid][i]=!marks[gid][i]; updateUI(); checkWinnerForGrid(gid); }); g.appendChild(cell); });
      card.appendChild(g); elGrids.appendChild(card);
    });
    visCount.textContent = selection.length + " affichée(s)";
  }
  // Ré-appliquer les marques
  for (let gid=0; gid<GRIDS.length; gid++) {
    for (let i=0; i<9; i++) {
      const cell = document.querySelector(`.cell[data-gid="${gid}"][data-idx="${i}"]`);
      if (!cell) continue;
      cell.classList.toggle("marked", !!marks[gid][i]);
    }
  }
}

function refreshRevealVisibility(){
  const wrap = document.querySelector("#current .reveal-wrap");
  if (!wrap) return;
  if (forceReveal) { wrap.classList.remove("hidden"); return; }
  if (REVEAL_MODE === "none") { wrap.classList.add("hidden"); return; }
  if (REVEAL_MODE === "end") { wrap.classList.add("hidden"); return; } // apparait à 0 (ou immédiatement si 0s)
  if (remaining === null || remaining > REVEAL_MODE) { wrap.classList.add("hidden"); }
  else { wrap.classList.remove("hidden"); }
}

function updateUI(){
  if (drawn.length===0) { elCurrent.textContent="Aucun tirage pour l'instant"; elCurrent.classList.add("small"); }
  else {
    elCurrent.classList.remove("small");
    const last = drawn[drawn.length-1]; const f = byName.get(last); elCurrent.innerHTML = `<div class=\"small\">Nom</div><div><strong>${last}</strong></div><div class=\"small\" style=\"margin-top:6px;\">Formule (<span id='revealVal'>${(REVEAL_MODE==='none'?'désactivée':(REVEAL_MODE==='end'?'à la fin':REVEAL_MODE+'s'))}</span>)</div><div class=\"reveal-wrap\"><span>${fmtFormula(f)}</span></div>`;
    refreshRevealVisibility();
  }
  elHistory.innerHTML = "";
  drawn.slice().reverse().forEach(v=>{
    const li = document.createElement("li");
    li.innerHTML = `<div><strong>${v}</strong></div>`;
    elHistory.appendChild(li);
  });
  for (let gid=0; gid<GRIDS.length; gid++) {
    for (let i=0; i<9; i++) {
      const cell = document.querySelector(`.cell[data-gid="${gid}"][data-idx="${i}"]`);
      if (!cell) continue;
      cell.classList.toggle("marked", !!marks[gid][i]);
    }
  }
  elDrawCount.textContent = `${drawn.length} / ${DATA.length}`;
}

function highlightLine(gid, kind, k){
  const idxs=[]; if (kind==="row") for(let c=0;c<3;c++) idxs.push(k*3+c); else for(let r=0;r<3;r++) idxs.push(r*3+k);
  idxs.forEach(i=>{ const cell=document.querySelector(`.cell[data-gid="${gid}"][data-idx="${i}"]`); if (cell) cell.classList.add("linewin"); });
}
function checkWinnerForGrid(gid){
  const selection = new Set(getSelection());
  if (!selection.has(gid)) return;
  const m=marks[gid]; let won=false; let parts=[];
  for (let r=0;r<3;r++) if (m.slice(r*3, r*3+3).every(Boolean)) { parts.push(`ligne ${r+1}`); highlightLine(gid,"row",r); won=true; }
  for (let c=0;c<3;c++) { const col=[0,1,2].map(r=>m[r*3+c]); if (col.every(Boolean)) { parts.push(`colonne ${c+1}`); highlightLine(gid,"col",c); won=true; } }
  if (won) announceWin(gid, parts.join(" & "));
}
function announceWin(gid, details){ const card=document.querySelector(`.grid-card[data-gid="${gid}"]`); if(!card) return;
  let b = card.querySelector(".winner-banner"); if(!b) { b=document.createElement("div"); b.className="winner-banner"; card.appendChild(b); }
  b.textContent = `Gagnant : ${details}`; card.scrollIntoView({behavior:"smooth", block:"center"});
}

// Tirage
function availablePool(){ const drawnSet=new Set(drawn); const actives=getActiveFamilies(); return DATA.filter(x=>actives.has(x.family)).map(x=>x.name).filter(n=>!drawnSet.has(n)); } function onDrawn(d){ const formula = byName.get(d); (INDEX.get(formula)||[]).forEach(pos=>{ const i=pos.row*3+pos.col; marks[pos.grid][i]=true; }); }
function drawOne(){ const pool = availablePool(); if (pool.length===0) return null; return pool[Math.floor(Math.random()*pool.length)]; }
function doDraw(){ ensureAudioCtx(); const d = drawOne(); if (!d) return; drawn.push(d);
  onDrawn(d); forceReveal=false; updateUI();
  const secs = parseInt(timerSelect.value, 10) || 30; startTimer(secs);
  // Gestion immédiate si 0s
  if (secs <= 0) { updateUI(); }
}

document.getElementById("draw").addEventListener("click", doDraw);
document.getElementById("undo").addEventListener("click", ()=>{ if(drawn.length===0) return; drawn.pop();
  marks = Array.from({length:50}, ()=>Array(9).fill(false));
  drawn.forEach(d=> onDrawn(d) );
  forceReveal=false; stopTimer(); updateUI();
});
document.getElementById("reset").addEventListener("click", ()=>{ drawn=[]; marks = Array.from({length:50}, ()=>Array(9).fill(false));
  document.querySelectorAll(".winner-banner").forEach(b=>b.remove()); forceReveal=false; stopTimer(); updateUI(); });

// Init
document.addEventListener("DOMContentLoaded", ()=>{ buildSelector(); renderGrids(); updateUI(); });

// === Surcouche: ajoute le badge de famille dans #current après rendu ===
(function(){
  const __origUpdateUI = updateUI;
  updateUI = function(){
    try { if (typeof __origUpdateUI === "function") __origUpdateUI(); } catch(e){}
    try {
      const current = document.getElementById("current"); if (!current) return;
      const last = (typeof drawn !== "undefined" && drawn && drawn.length) ? drawn[drawn.length-1] : null; if (!last) return;
      const subtitleEl = document.querySelector('.subtitle');
      const subtitle = subtitleEl ? subtitleEl.textContent : '';
      const isNomToFormula = subtitle.toLowerCase().includes('nom') && !subtitle.toLowerCase().includes('formule ➜ nom'); // rough
      // Heuristic: in Nom ➜ Formule, 'last' est un nom; dans Formule ➜ Nom, 'last' est une formule
      const rec = isNomToFormula ? recordByName(last) : recordByFormula(last);
      const fam = rec && rec.family ? rec.family : null;
      if (!fam) return;
      const strongEl = current.querySelector('strong');
      // Respect user toggle
      if (!getShowFamily()) {
        const existing = current.querySelector('.badge-family');
        if (existing) existing.remove();
        return;
      }
      if (!strongEl) return;
      let badge = current.querySelector('.badge-family');
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'badge-family';
        badge.textContent = fam;
        strongEl.insertAdjacentElement('afterend', badge);
      } else {
        badge.textContent = fam;
      }
    } catch(e){ /* no-op */ }
  };
})();

</script>
</body>
</html>
