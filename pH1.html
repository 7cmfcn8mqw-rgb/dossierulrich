<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Simulation d‚Äôun pH-m√®tre</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      user-select: none;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      color: #111827;
      transition: background-color 0.2s;
    }

    
    .version-box {
      position: fixed;
      top: 10px;
      right: 10px;
      border: 1px solid rgba(0,0,0,0.6);
      padding: 4px 6px;
      font-size: 10px;
      line-height: 1.2;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 4px;
      text-align: center;
      color: #111827;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      z-index: 20;
    }

@keyframes flashRed {
      0%   { background-color: #f3f4f6; }
      20%  { background-color: #fee2e2; }
      50%  { background-color: #fecaca; }
      100% { background-color: #f3f4f6; }
    }

    body.flash-red {
      animation: flashRed 0.6s ease-out;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
    }

    .tab-btn {
      flex: 1 1 33%;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .tab-btn.active {
      background: #ffffff;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    /* Carte du pH-m√®tre : toute verte */
    .meter-card {
      flex: 1 1 100%;
      background: linear-gradient(135deg, #0e8f9a, #18a1ab);
      color: #f9fafb;
    }

    .beaker-card {
      flex: 1 1 100%;
    }

    .log-card {
      flex: 1 1 100%;
    }

    .meter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .meter-header h2 {
      font-size: 1.1rem;
      margin: 0;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      background: #e5e7eb;
      transition:
        transform 0.05s ease,
        box-shadow 0.05s ease,
        background 0.15s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary.off {
      background: #9ca3af;
    }

    .btn-small {
      font-size: 0.78rem;
      padding: 4px 10px;
    }

    .status-indicators {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 0.8rem;
      align-items: center;
    }

    .led {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #9ca3af;
      box-shadow: 0 0 0 1px #6b7280 inset;
    }

    .led.on {
      background: #22c55e;
      box-shadow: 0 0 4px 1px rgba(34, 197, 94, 0.7);
    }

    .led.warn {
      background: #f97316;
      box-shadow: 0 0 4px 1px rgba(249, 115, 22, 0.7);
    }

    /* Afficheur : fond blanc, √©criture noire */

    .digital-panel {
      background: #ffffff;
      color: #111827;
      border-radius: 10px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border: 1px solid #0b7280;
      min-width: 0;
    }

    .digital-reading {
      font-family: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 2.2rem;
      letter-spacing: 0.08em;
    }

    .digital-unit {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .digital-status {
      font-size: 0.75rem;
      opacity: 0.9;
      text-align: right;
    }

    /* Nouvelle mise en page : afficheur √† gauche, commandes √† droite */

    .meter-main {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .meter-main-left {
      flex: 1 1 260px;
      min-width: 0;
    }

    .meter-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    @media (max-width: 780px) {
      .meter-controls {
        align-items: flex-start;
      }
    }

    /* Panneau des potentiom√®tres */

    .knob-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: flex-end;
      margin-bottom: 0;
      margin-top: 4px;
    }

    .knob-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 110px;
    }

    .knob-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .knob-arrows {
      font-size: 1.1rem;
      margin-bottom: 4px;
      opacity: 0.9;
    }

    .knob {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #f9fafb, #d1d5db);
      border: 1px solid #9ca3af;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.1s ease;
    }

    .knob:active {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.45);
    }

    .knob-indicator {
      position: absolute;
      width: 4px;
      height: 20px;
      border-radius: 999px;
      background: #4b5563;
      top: 6px;
      transform-origin: 50% 22px;
    }

    .meter-buttons {
      display: none; /* anciennes touches de calibration masqu√©es */
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .meter-buttons .btn {
      flex: 1 1 120px;
      text-align: center;
    }

    .stir-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 0;
      margin-top: 4px;
      font-size: 0.8rem;
      align-items: center;
    }

    .stir-buttons-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .power-wrapper {
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .meter-status {
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .meter-status p {
      margin: 2px 0;
    }

    .beaker-grid {
      position: relative;
      display: grid;
      grid-template-columns: repeat(4, minmax(150px, 1fr));
      gap: 12px;
    }

    .beaker {
      position: relative;
      padding: 10px;
      text-align: center;
      border-radius: 12px;
      background: linear-gradient(145deg, #e5e7eb, #ffffff);
      cursor: pointer;
      transition:
        transform 0.08s ease,
        box-shadow 0.08s ease,
        border 0.08s,
        background 0.1s;
      border: 2px solid transparent;
      min-height: 260px;
      overflow: hidden;
    }

    .beaker:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }

    .beaker.active {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
    }

    .beaker-title {
      font-weight: 600;
      margin-bottom: 4px;
      min-height: 2.4em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .beaker-subtitle {
      font-size: 0.8rem;
      margin-bottom: 6px;
      min-height: 1.8em;
    }

    .beaker-graphic {
      position: relative;
      height: 220px;
      margin-bottom: 4px;
    }

    .solution {
      position: absolute;
      left: 12%;
      width: 76%;
      bottom: 0;
      height: 120px;
      border-radius: 0 0 12px 12px;
      background: linear-gradient(to top, #bfdbfe, #eff6ff);
      border: 1px solid #93c5fd;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      transition: background 0.25s ease, border-color 0.25s ease;
    }

    .solution-line {
      position: absolute;
      left: 12%;
      width: 76%;
      bottom: 120px;
      height: 2px;
      background: rgba(37, 99, 235, 0.7);
    }

    .beaker-color-green .solution {
      background: linear-gradient(
        to top,
        rgba(57, 255, 20, 0.95),
        rgba(232, 255, 220, 0.98)
      );
      border-color: rgba(16, 185, 129, 1);
    }

    .beaker-color-pink .solution {
      background: linear-gradient(
        to top,
        rgba(255, 20, 147, 0.95),
        rgba(255, 225, 244, 0.98)
      );
      border-color: rgba(236, 72, 153, 1);
    }

    /* CuSO4 : plus fonc√© en B√©cher 1, plus clair en B√©cher 2 */
    .solution-cuso4-strong {
      background: linear-gradient(
        to top,
        rgba(37, 99, 235, 0.95),
        rgba(191, 219, 254, 0.98)
      );
      border-color: rgba(37, 99, 235, 1);
    }

    .solution-cuso4-weak {
      background: linear-gradient(
        to top,
        rgba(96, 165, 250, 0.9),
        rgba(219, 234, 254, 0.98)
      );
      border-color: rgba(96, 165, 250, 1);
    }

    .stirrer {
      width: 26px;
      height: 6px;
      border-radius: 999px;
      background: #ffffff;
      opacity: 0.8;
      margin-bottom: 10px;
      transform-origin: center;
      transition: opacity 0.2s ease;
    }

    .stirrer.on {
      opacity: 1;
      animation: stir-length 0.5s linear infinite;
    }

    @keyframes stir-length {
      0%   { transform: scaleX(1); }
      20%  { transform: scaleX(0.7); }
      40%  { transform: scaleX(0.4); }
      60%  { transform: scaleX(0.9); }
      80%  { transform: scaleX(1.3); }
      100% { transform: scaleX(1); }
    }

    .electrode-graphic {
      position: absolute;
      left: 50%;
      width: 12px;
      height: 160px;
      transform: translate(-50%, -40px);
      transition: transform 0.25s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
    }

    .electrode-rod {
      flex: 1;
      width: 4px;
      background: #9ca3af;
      border-radius: 999px;
    }

    .electrode-bulb {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #e5e7eb;
      border: 1px solid #9ca3af;
      box-shadow: 0 0 4px rgba(148, 163, 184, 0.9);
      margin-top: 2px;
    }

    .beaker.active .electrode-graphic {
      transform: translate(-50%, 40px);
    }

    .select-wrapper {
      margin-top: 4px;
    }

    select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      font-size: 0.8rem;
      background: #f9fafb;
    }

    .log-card h3 {
      font-size: 0.9rem;
      margin-top: 0;
      margin-bottom: 4px;
    }

    .log {
      font-size: 0.8rem;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
      border-top: 1px solid #e5e7eb;
      margin-top: 6px;
      padding-top: 6px;
    }

    .log-entry {
      margin-bottom: 2px;
    }

    .log-entry span.time {
      color: #6b7280;
      margin-right: 4px;
    }
  
/* --- Mode paysage (mobile/tablette) : iOS/Android ---
   On ne peut pas forcer l'orientation, mais on affiche un √©cran demandant le paysage
   (compatible Safari + "Sur l'√©cran d'accueil"). */
.landscapeOnlyMsg{
  display:none;
  position:fixed;
  inset:0;
  z-index:100000;
  background:rgba(255,255,255,0.96);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  padding:24px;
  box-sizing:border-box;
  text-align:center;
}
.landscapeOnlyMsg .box{
  max-width:520px;
  margin:0 auto;
  border:1px solid rgba(0,0,0,0.12);
  border-radius:18px;
  background:#fff;
  box-shadow: 0 10px 30px rgba(0,0,0,.10);
  padding:18px 16px;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
.landscapeOnlyMsg .icon{ font-size:44px; line-height:1; margin-bottom:10px; }
.landscapeOnlyMsg .title{ font-size:18px; font-weight:900; margin-bottom:6px; }
.landscapeOnlyMsg .txt{ font-size:14px; color:#333; line-height:1.35; }
html.isPortrait .landscapeOnlyMsg{
  display:flex;
  align-items:center;
  justify-content:center;
}

</style>
</head>
<body>

  <!-- Message mode portrait (t√©l√©phone/tablette) -->
  <div class="landscapeOnlyMsg" aria-live="polite">
    <div class="box">
      <div class="icon">üîÑ</div>
      <div class="title">Passe en mode paysage</div>
      <div class="txt">
        Pour utiliser cette activit√© sur t√©l√©phone ou tablette,<br>
        tourne l‚Äôappareil en <strong>mode paysage</strong>.
      </div>
    </div>
  </div>


  <div class="version-box">
    Version 1.4<br>
    S. Ulrich ‚Äî ECG Henry-Dunant
  </div>


  <div class="app">
    <h1>Simulation d‚Äôun pH-m√®tre</h1>

    <div class="tabs">
      <button id="tabA" class="tab-btn active">Partie A (calibration)</button>
      <button id="tabB" class="tab-btn">Partie B</button>
      <button id="tabC" class="tab-btn">Partie C</button>
    </div>

    <div class="row">
      <div class="card meter-card">
        <div class="meter-header">
          <h2>pH-m√®tre</h2>
        </div>

        <div class="status-indicators">
          <span>Alimentation :</span>
          <div id="ledPower" class="led"></div>
          <span>Calibration :</span>
          <div id="ledCal" class="led"></div>
        </div>

        <!-- Afficheur + commandes -->
        <div class="meter-main">
          <div class="meter-main-left">
            <div id="digitalPanel" class="digital-panel">
              <div>
                <div id="digitalValue" class="digital-reading">--.-</div>
              </div>
              <div style="text-align: right;">
                <div class="digital-unit">pH</div>
                <div id="digitalStatus" class="digital-status">√âteint</div>
              </div>
            </div>
          </div>

          <div class="meter-controls">
            <div class="knob-panel">
              <div class="knob-block">
                <div class="knob-label">R√©glage pH 7</div>
                <div class="knob-arrows">‚ü≤ ‚ü≥</div>
                <div class="knob" id="knob7">
                  <div class="knob-indicator"></div>
                </div>
              </div>
              <div class="knob-block">
                <div class="knob-label">R√©glage pH 4</div>
                <div class="knob-arrows">‚ü≤ ‚ü≥</div>
                <div class="knob" id="knob4">
                  <div class="knob-indicator"></div>
                </div>
              </div>
            </div>

            <div class="stir-buttons">
              <span class="stir-buttons-label">Agitateurs (1 &amp; 2) :</span>
              <button id="stir1Btn" class="btn btn-small">Agitateur 1 : OFF</button>
              <button id="stir2Btn" class="btn btn-small">Agitateur 2 : OFF</button>
            </div>

            <div class="power-wrapper">
              <button id="powerBtnVisible" class="btn btn-primary off">Marche / Arr√™t</button>
            </div>
          </div>
        </div>

        <!-- anciens boutons (cach√©s par CSS mais toujours l√†) -->
        <div class="meter-buttons">
          <button id="powerBtn" class="btn btn-primary off">Marche / Arr√™t</button>
          <button id="cal7Btn" class="btn">Calibrer pH 7</button>
          <button id="calSlopeBtn" class="btn">Calibrer pH 4</button>
        </div>

        <div class="meter-status">
          <p id="partDescription"></p>
          <p id="electrodeStatus"></p>
          <p id="rinseStatus"></p>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card beaker-card">
        <h2 style="font-size: 1rem; margin-top: 0; margin-bottom: 8px;">B√©chers</h2>
        <div class="beaker-grid">
          <div class="beaker" data-becher="1">
            <div class="beaker-graphic">
              <div class="solution">
                <div class="stirrer" data-stirrer="1"></div>
              </div>
              <div class="solution-line"></div>
            </div>
            <div class="beaker-title" id="b1Title"></div>
            <div class="beaker-subtitle" id="b1Subtitle"></div>
            <div class="select-wrapper" id="b1SelectWrapper" style="display: none;">
              <select id="b1Select"></select>
            </div>
          </div>

          <div class="beaker" data-becher="2">
            <div class="beaker-graphic">
              <div class="solution">
                <div class="stirrer" data-stirrer="2"></div>
              </div>
              <div class="solution-line"></div>
            </div>
            <div class="beaker-title" id="b2Title"></div>
            <div class="beaker-subtitle" id="b2Subtitle"></div>
            <div class="select-wrapper" id="b2SelectWrapper" style="display: none;">
              <select id="b2Select"></select>
            </div>
          </div>

          <div class="beaker" data-becher="3">
            <div class="beaker-graphic">
              <div class="solution"></div>
              <div class="solution-line"></div>
            </div>
            <div class="beaker-title" id="b3Title"></div>
            <div class="beaker-subtitle" id="b3Subtitle"></div>
          </div>

          <div class="beaker" data-becher="4">
            <div class="beaker-graphic">
              <div class="solution"></div>
              <div class="solution-line"></div>
            </div>
            <div class="beaker-title" id="b4Title"></div>
            <div class="beaker-subtitle" id="b4Subtitle"></div>
          </div>
        </div>

        <div id="electrode" class="electrode-graphic">
          <div class="electrode-rod"></div>
          <div class="electrode-bulb"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card log-card">
        <h3>Journal des actions</h3>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <script>
    const state = {
      poweredOn: false,
      calibratedMid: false,
      calibratedSlope: false,
      currentReading: null,
      part: "A",
      currentBecher: 4,
      rinsedSinceLastSolution: false,
      stirrer1On: false,
      stirrer2On: false,
      calibrationStep: 0,
      knob7Angle: 0,
      knob4Angle: 0,
      prevB1Value: "",
      prevB2Value: "",
    };

    const KNOB_MIN = -135;
    const KNOB_MAX = 135;

    const tabA = document.getElementById("tabA");
    const tabB = document.getElementById("tabB");
    const tabC = document.getElementById("tabC");

    const powerBtnHidden = document.getElementById("powerBtn");
    const powerBtnVisible = document.getElementById("powerBtnVisible");
    const cal7Btn = document.getElementById("cal7Btn");
    const calSlopeBtn = document.getElementById("calSlopeBtn");
    const knob7 = document.getElementById("knob7");
    const knob4 = document.getElementById("knob4");

    const stir1Btn = document.getElementById("stir1Btn");
    const stir2Btn = document.getElementById("stir2Btn");

    const digitalValue = document.getElementById("digitalValue");
    const digitalStatus = document.getElementById("digitalStatus");
    const ledPower = document.getElementById("ledPower");
    const ledCal = document.getElementById("ledCal");

    const partDescription = document.getElementById("partDescription");
    const electrodeStatus = document.getElementById("electrodeStatus");
    const rinseStatus = document.getElementById("rinseStatus");
    const logContainer = document.getElementById("log");

    const bechers = document.querySelectorAll(".beaker");
    const electrodeEl = document.getElementById("electrode");

    const b1Title = document.getElementById("b1Title");
    const b1Subtitle = document.getElementById("b1Subtitle");
    const b2Title = document.getElementById("b2Title");
    const b2Subtitle = document.getElementById("b2Subtitle");
    const b3Title = document.getElementById("b3Title");
    const b3Subtitle = document.getElementById("b3Subtitle");
    const b4Title = document.getElementById("b4Title");
    const b4Subtitle = document.getElementById("b4Subtitle");

    const b1SelectWrapper = document.getElementById("b1SelectWrapper");
    const b2SelectWrapper = document.getElementById("b2SelectWrapper");
    const b1Select = document.getElementById("b1Select");
    const b2Select = document.getElementById("b2Select");

    const becher1Div = document.querySelector('.beaker[data-becher="1"]');
    const becher2Div = document.querySelector('.beaker[data-becher="2"]');

    const stirrers = document.querySelectorAll(".stirrer");

    const solutionColorsEveryday = {
      coca: { bg1: "#4b2e11", bg2: "#8a5a26" },
      citron: { bg1: "#f6e766", bg2: "#fff9c2" },
      vinaigre: { bg1: "#f5f5f5", bg2: "#ffffff" },
      cafe: { bg1: "#3c2f1b", bg2: "#6b5130" },
      eau_robinet: { bg1: "#dff2ff", bg2: "#f4fbff" },
      eau_distillee: { bg1: "#f8fcff", bg2: "#ffffff" },
      eau_minerale: { bg1: "#cfe8ff", bg2: "#e8f3ff" },
      tomate: { bg1: "#ff4a2e", bg2: "#ffb3a3" },
    };

    const phEveryday = {
      coca: 2.5,
      citron: 2.0,
      vinaigre: 2.5,
      cafe: 5.0,
      eau_robinet: 6.8,
      eau_distillee: 7.0,
      eau_minerale: 7.5,
      tomate: 4.2,
    };

    function isFullyCalibrated() {
      return state.calibratedMid && state.calibratedSlope;
    }

    function log(message) {
      const entry = document.createElement("div");
      entry.className = "log-entry";
      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      timeSpan.textContent = `[${hh}:${mm}]`;
      const msgSpan = document.createElement("span");
      msgSpan.className = "msg";
      msgSpan.textContent = " " + message;
      entry.appendChild(timeSpan);
      entry.appendChild(msgSpan);
      logContainer.prepend(entry);
    }

    function formatPhValue(v) {
      if (v === null || isNaN(v)) return "--.-";
      return v.toFixed(1);
    }

    function attachElectrodeToBecher(n) {
      const targetGraphic = document.querySelector(
        '.beaker[data-becher="' + n + '"] .beaker-graphic',
      );
      if (targetGraphic) {
        targetGraphic.appendChild(electrodeEl);
      }
    }

    function updateStirrerButtonsUI() {
      stir1Btn.textContent = "Agitateur 1 : " + (state.stirrer1On ? "ON" : "OFF");
      stir2Btn.textContent = "Agitateur 2 : " + (state.stirrer2On ? "ON" : "OFF");
      stir1Btn.classList.toggle("btn-primary", state.stirrer1On);
      stir2Btn.classList.toggle("btn-primary", state.stirrer2On);
    }

    function updateStirrers() {
      stirrers.forEach((s) => {
        const id = s.dataset.stirrer;
        const logicalOn = id === "1" ? state.stirrer1On : state.stirrer2On;
        const shouldSpin = state.poweredOn && logicalOn;
        s.classList.toggle("on", shouldSpin);
      });
    }

    function getTruePh() {
      const b = state.currentBecher;
      if (b === null) return null;

      if (state.part === "A") {
        if (b === 1) return 7.0;
        if (b === 2) return 4.0;
        return null;
      }

      if (state.part === "B") {
        if (b !== 1 && b !== 2) return null;
        const sel = b === 1 ? b1Select.value : b2Select.value;
        if (!sel) return null;
        return phEveryday[sel] ?? null;
      }

      if (state.part === "C") {
        if (b === 3 || b === 4) return null;
        let sol, c;
        if (b === 1) {
          sol = b1Select.value || null;
          c = 0.1;
        } else if (b === 2) {
          sol = b2Select.value || null;
          c = 0.02;
        } else {
          return null;
        }
        if (!sol) return null;

        if (sol === "AlCl3") {
          return c === 0.1 ? 2.7 : 3.1;
        } else if (sol === "CuSO4") {
          return c === 0.1 ? 4.0 : 4.5;
        } else if (sol === "LiCl") {
          return 7.0;
        } else if (sol === "CH3COONa") {
          return c === 0.1 ? 8.9 : 8.4;
        } else if (sol === "NaCl") {
          return 7.0;
        } else if (sol === "NaHCO3") {
          return c === 0.1 ? 8.3 : 8.1;
        } else if (sol === "Na2CO3") {
          return c === 0.1 ? 11.6 : 11.2;
        } else if (sol === "KCl") {
          return 7.0;
        }
      }
      return null;
    }

    function computeReading(truePh) {
      if (!state.poweredOn || truePh === null) return null;
      const rand = Math.random() - 0.5;

      if (!state.calibratedMid) {
        return truePh + 0.6 + rand * 0.3;
      } else if (state.calibratedMid && !state.calibratedSlope) {
        if (Math.abs(truePh - 7) < 0.3) {
          return 7.0 + rand * 0.05;
        } else {
          return truePh + (truePh > 7 ? 0.3 : -0.3) + rand * 0.1;
        }
      } else {
        return truePh + rand * 0.05;
      }
    }

    function updateDisplay() {
      const reading = state.poweredOn ? state.currentReading : null;
      digitalValue.textContent = formatPhValue(reading);

      if (!state.poweredOn) {
        digitalStatus.textContent = "√âteint";
      } else if (state.calibratedMid && state.calibratedSlope) {
        digitalStatus.textContent = "Calibr√© (pH 7 & 4)";
      } else if (state.calibratedMid) {
        digitalStatus.textContent = "Calibr√© sur pH 7";
      } else {
        digitalStatus.textContent = "Non calibr√©";
      }

      ledCal.classList.remove("on", "warn");
      if (state.calibratedMid && state.calibratedSlope) {
        ledCal.classList.add("on");
      } else if (state.calibratedMid) {
        ledCal.classList.add("warn");
      }
    }

    function recalcReadingFromPosition() {
      const truePh = getTruePh();
      state.currentReading = computeReading(truePh);
      updateDisplay();
    }

    function getRandomKnobAngle() {
      const preset = [-120, -90, -60, -30, 30, 60, 90, 120];
      const idx = Math.floor(Math.random() * preset.length);
      return preset[idx];
    }

    function resetSimulationState() {
      state.poweredOn = false;
      state.calibratedMid = false;
      state.calibratedSlope = false;
      state.currentReading = null;
      state.part = "A";
      state.currentBecher = 4;
      state.rinsedSinceLastSolution = false;
      state.stirrer1On = false;
      state.stirrer2On = false;
      state.calibrationStep = 0;
      state.knob7Angle = getRandomKnobAngle();
      state.knob4Angle = getRandomKnobAngle();
      state.prevB1Value = "";
      state.prevB2Value = "";
      setKnobAngle(knob7, state.knob7Angle);
      setKnobAngle(knob4, state.knob4Angle);

      attachElectrodeToBecher(4);
      ledPower.classList.remove("on");
      powerBtnVisible.classList.add("off");
      updateStirrerButtonsUI();
      updateStirrers();
      updatePartUI();
      updateElectrodeStatus();
      updateDisplay();
    }

    function triggerCalibrationError(reason) {
      document.body.classList.add("flash-red");
      setTimeout(() => document.body.classList.remove("flash-red"), 600);

      log(
        "‚ö† Erreur de m√©thode de calibration : " +
          reason +
          " ‚Äî la simulation recommence depuis le d√©but.",
      );

      resetSimulationState();
    }

    function resetAfterContamination() {
      log(
        "‚ùå Rin√ßage oubli√© : contamination de l‚Äô√©lectrode. Remise √† z√©ro (retour au b√©cher de repos).",
      );
      state.currentBecher = 4;
      state.rinsedSinceLastSolution = false;
      state.calibratedMid = false;
      state.calibratedSlope = false;
      state.currentReading = null;
      state.calibrationStep = 0;
      attachElectrodeToBecher(4);
      updateElectrodeStatus();
      updateDisplay();
    }

    function fillSelect(selectEl, options, placeholder) {
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);
      options.forEach((o) => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        selectEl.appendChild(opt);
      });
    }

    const everydayOptions = [
      { value: "coca", label: "Coca-cola" },
      { value: "citron", label: "Citron (jus)" },
      { value: "vinaigre", label: "Vinaigre" },
      { value: "cafe", label: "Caf√©" },
      { value: "eau_robinet", label: "Eau du robinet" },
      { value: "eau_distillee", label: "Eau distill√©e" },
      { value: "eau_minerale", label: "Eau min√©rale" },
      { value: "tomate", label: "Jus de tomate" },
    ];

    const saltOptions = [
      { value: "AlCl3", label: "AlCl‚ÇÉ" },
      { value: "CuSO4", label: "CuSO‚ÇÑ" },
      { value: "LiCl", label: "LiCl" },
      { value: "CH3COONa", label: "CH‚ÇÉCOONa" },
      { value: "NaCl", label: "NaCl" },
      { value: "NaHCO3", label: "NaHCO‚ÇÉ" },
      { value: "Na2CO3", label: "Na‚ÇÇCO‚ÇÉ" },
      { value: "KCl", label: "KCl" },
    ];

    function resetSolutionStyle(solDiv) {
      solDiv.classList.remove("solution-cuso4-strong", "solution-cuso4-weak");
      solDiv.style.background = "linear-gradient(to top,#bfdbfe,#eff6ff)";
      solDiv.style.borderColor = "#93c5fd";
    }

    function updateSolutionsAppearance() {
      const s1 = becher1Div.querySelector(".solution");
      const s2 = becher2Div.querySelector(".solution");

      if (state.part === "A") {
        s1.style.background = "";
        s1.style.borderColor = "";
        s2.style.background = "";
        s2.style.borderColor = "";

        becher1Div.classList.add("beaker-color-green");
        becher2Div.classList.add("beaker-color-pink");
        return;
      }

      resetSolutionStyle(s1);
      resetSolutionStyle(s2);
      becher1Div.classList.remove("beaker-color-green");
      becher2Div.classList.remove("beaker-color-pink");

      if (state.part === "B") {
        const setColor = (solDiv, value) => {
          if (!value || !solutionColorsEveryday[value]) return;
          const c = solutionColorsEveryday[value];
          solDiv.style.background = `linear-gradient(to top, ${c.bg1}, ${c.bg2})`;
          solDiv.style.borderColor = "#555";
        };
        setColor(s1, b1Select.value);
        setColor(s2, b2Select.value);
        return;
      }

      if (state.part === "C") {
        if (b1Select.value === "CuSO4") s1.classList.add("solution-cuso4-strong");
        if (b2Select.value === "CuSO4") s2.classList.add("solution-cuso4-weak");
      }
    }

    function updateTabsUI() {
      [tabA, tabB, tabC].forEach((btn) => btn.classList.remove("active"));
      if (state.part === "A") tabA.classList.add("active");
      else if (state.part === "B") tabB.classList.add("active");
      else tabC.classList.add("active");
    }

    function updatePartUI() {
      updateTabsUI();

      if (state.part === "A") {
        partDescription.innerHTML =
          "<strong>Partie A :</strong> tampons pH 7 et pH 4, avec rin√ßage et b√©cher de repos.";
        b1Title.textContent = "B√©cher 1 ‚Äì Tampon pH 7";
        b1Subtitle.textContent = "solution tampon pH 7";
        b2Title.textContent = "B√©cher 2 ‚Äì Tampon pH 4";
        b2Subtitle.textContent = "solution tampon pH 4";
        b3Title.textContent = "B√©cher 3 ‚Äì Rin√ßage";
        b3Subtitle.textContent = "";
        b4Title.textContent = "B√©cher 4 ‚Äì Repos";
        b4Subtitle.textContent = "";

        b1SelectWrapper.style.display = "none";
        b2SelectWrapper.style.display = "none";
      } else if (state.part === "B") {
        partDescription.innerHTML =
          "<strong>Partie B :</strong> produits de la vie quotidienne (boissons, jus, eaux).";
        b1Title.textContent = "B√©cher 1 ‚Äì Produit";
        b1Subtitle.textContent = "";
        b2Title.textContent = "B√©cher 2 ‚Äì Eaux";
        b2Subtitle.textContent = "";
        b3Title.textContent = "B√©cher 3 ‚Äì Rin√ßage";
        b3Subtitle.textContent = "";
        b4Title.textContent = "B√©cher 4 ‚Äì Repos";
        b4Subtitle.textContent = "";

        b1SelectWrapper.style.display = "block";
        b2SelectWrapper.style.display = "block";

        const eaux = ["eau_robinet", "eau_distillee", "eau_minerale"];
        const nonEaux = everydayOptions.filter(o => !eaux.includes(o.value));
        const onlyEaux = everydayOptions.filter(o => eaux.includes(o.value));

        fillSelect(b1Select, nonEaux, "‚Äî choisir un produit ‚Äî");
        fillSelect(b2Select, onlyEaux, "‚Äî choisir une eau ‚Äî");
        state.prevB1Value = b1Select.value;
        state.prevB2Value = b2Select.value;
      } else {
        partDescription.innerHTML =
          "<strong>Partie C :</strong> solutions de sels (0,10 mol¬∑L‚Åª¬π et 0,020 mol¬∑L‚Åª¬π).";

        b1Title.textContent = "B√©cher 1 ‚Äì 0,10 M";
        b1Subtitle.textContent = "";
        b2Title.textContent = "B√©cher 2 ‚Äì 0,020 M";
        b2Subtitle.textContent = "";

        b3Title.textContent = "B√©cher 3 ‚Äì Rin√ßage";
        b3Subtitle.textContent = "";
        b4Title.textContent = "B√©cher 4 ‚Äì Repos";
        b4Subtitle.textContent = "";

        b1SelectWrapper.style.display = "block";
        b2SelectWrapper.style.display = "block";
        fillSelect(b1Select, saltOptions, "‚Äî choisir une solution ‚Äî");
        fillSelect(b2Select, saltOptions, "‚Äî choisir une solution ‚Äî");
        state.prevB1Value = b1Select.value;
        state.prevB2Value = b2Select.value;
      }

      updateSolutionsAppearance();
      updateElectrodeStatus();
      recalcReadingFromPosition();
    }

    function updateElectrodeStatus() {
      let label = "dans l‚Äôair (pas dans un b√©cher)";
      if (state.currentBecher === 1) {
        if (state.part === "A") {
          label = "dans le B√©cher 1 (tampon pH 7)";
        } else if (state.part === "B") {
          const sol = b1Select.value || "produit";
          label = "dans le B√©cher 1 (" + sol + ")";
        } else {
          const sol = b1Select.value || "solution";
          label = "dans le B√©cher 1 (" + sol + ", c = 0,10 mol¬∑L‚Åª¬π)";
        }
      } else if (state.currentBecher === 2) {
        if (state.part === "A") {
          label = "dans le B√©cher 2 (tampon pH 4)";
        } else if (state.part === "B") {
          const sol = b2Select.value || "eau";
          label = "dans le B√©cher 2 (" + sol + ")";
        } else {
          const sol = b2Select.value || "solution";
          label = "dans le B√©cher 2 (" + sol + ", c = 0,020 mol¬∑L‚Åª¬π)";
        }
      } else if (state.currentBecher === 3) {
        label = "dans le B√©cher 3 (rin√ßage)";
      } else if (state.currentBecher === 4) {
        label = "dans le B√©cher 4 (repos)";
      }

      electrodeStatus.innerHTML = "√âlectrode : <strong>" + label + "</strong>";

      if (state.rinsedSinceLastSolution) {
        rinseStatus.innerHTML =
          "√âtat : <strong>√©lectrode rinc√©e</strong>, tu peux changer de b√©cher.";
      } else {
        rinseStatus.innerHTML =
          "√âtat : <strong>attention</strong>, rin√ßage obligatoire avant de changer de b√©cher (sauf vers le B√©cher 3).";
      }

      bechers.forEach((b) => {
        const n = parseInt(b.dataset.becher, 10);
        b.classList.toggle("active", n === state.currentBecher);
      });
    }

    function canMoveToBecher(target) {
      if (state.currentBecher === null) return true;
      if (target === 3) return true;
      if (target === state.currentBecher) return true;

      if (!state.rinsedSinceLastSolution && state.currentBecher !== 3) {
        resetAfterContamination();
        return false;
      }
      return true;
    }

    function moveElectrodeToBecher(target) {
      if (!canMoveToBecher(target)) return;
      const previous = state.currentBecher;
      state.currentBecher = target;

      attachElectrodeToBecher(target);

      if (target === 3) {
        state.rinsedSinceLastSolution = true;
        log("√âlectrode rinc√©e dans le B√©cher 3 (eau distill√©e).");

        if (state.part === "A" && state.calibrationStep === 1) {
          state.calibrationStep = 2;
        }
      } else if (target === 1 || target === 2 || target === 4) {
        if (previous === null) {
          log("√âlectrode plong√©e dans le B√©cher " + target + ".");
        } else if (previous === 3) {
          log(
            "√âlectrode pass√©e du B√©cher 3 (rin√ßage) au B√©cher " + target + ".",
          );
        } else {
          log("√âlectrode d√©plac√©e vers le B√©cher " + target + ".");
        }
        state.rinsedSinceLastSolution = false;
      }

      updateElectrodeStatus();
      recalcReadingFromPosition();
    }

    [tabA, tabB, tabC].forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetPart = btn === tabA ? "A" : btn === tabB ? "B" : "C";
        if (targetPart === state.part) return;

        if (state.part === "A" && targetPart !== "A") {
          if (!isFullyCalibrated()) {
            log(
              "Partie " +
                targetPart +
                " verrouill√©e : commence par une calibration correcte en Partie A (pH 7 puis pH 4, avec rin√ßage).",
            );
            return;
          }
          if (state.currentBecher !== 4) {
            log(
              "Partie " +
                targetPart +
                " verrouill√©e : mets d‚Äôabord l‚Äô√©lectrode au repos dans le B√©cher 4 pour changer de partie.",
            );
            return;
          }
        }

        if (state.part !== "A" && targetPart !== "A") {
          if (state.currentBecher !== 4) {
            log(
              "Pour passer de la Partie " +
                state.part +
                " √† la Partie " +
                targetPart +
                ", mets d‚Äôabord l‚Äô√©lectrode au repos dans le B√©cher 4.",
            );
            return;
          }
        }

        state.part = targetPart;
        log("Changement de partie : Partie " + targetPart + ".");
        updatePartUI();
      });
    });

    bechers.forEach((b) => {
      b.addEventListener("click", () => {
        const n = parseInt(b.dataset.becher, 10);
        moveElectrodeToBecher(n);
      });
    });

    /* Blocage changement de solution si √©lectrode dans le b√©cher + synchro C */

    b1Select.addEventListener("change", () => {
      const newVal = b1Select.value;

      if ((state.part === "B" || state.part === "C") && state.currentBecher === 1) {
        log(
          "Impossible de changer la solution dans le B√©cher 1 : l‚Äô√©lectrode est plong√©e dedans.",
        );
        b1Select.value = state.prevB1Value || "";
        return;
      }

      if (state.part === "B") {
        log("B√©cher 1 configur√© avec : " + (newVal || "aucun produit"));
      } else if (state.part === "C") {
        log("B√©cher 1 configur√© avec : " + (newVal || "aucune solution"));

        // synchronisation vers B√©cher 2 (sens unique) en Partie C
        if (state.currentBecher === 2) {
          log(
            "La solution du B√©cher 2 ne peut pas √™tre modifi√©e automatiquement : l‚Äô√©lectrode est plong√©e dedans.",
          );
        } else {
          b2Select.value = newVal;
          state.prevB2Value = newVal;
          log(
            "M√™me esp√®ce chimique appliqu√©e automatiquement dans le B√©cher 2 (concentration diff√©rente).",
          );
        }
      }

      state.prevB1Value = newVal;
      updateSolutionsAppearance();
      recalcReadingFromPosition();
    });

    b2Select.addEventListener("change", () => {
      const newVal = b2Select.value;

      if ((state.part === "B" || state.part === "C") && state.currentBecher === 2) {
        log(
          "Impossible de changer la solution dans le B√©cher 2 : l‚Äô√©lectrode est plong√©e dedans.",
        );
        b2Select.value = state.prevB2Value || "";
        return;
      }

      if (state.part === "B") {
        log("B√©cher 2 configur√© avec : " + (newVal || "aucune eau"));
      } else if (state.part === "C") {
        log("B√©cher 2 configur√© avec : " + (newVal || "aucune solution"));
      }

      state.prevB2Value = newVal;
      updateSolutionsAppearance();
      recalcReadingFromPosition();
    });

    stir1Btn.addEventListener("click", () => {
      state.stirrer1On = !state.stirrer1On;
      updateStirrerButtonsUI();
      updateStirrers();
      log("Agitateur 1 " + (state.stirrer1On ? "activ√©" : "d√©sactiv√©") + ".");
    });

    stir2Btn.addEventListener("click", () => {
      state.stirrer2On = !state.stirrer2On;
      updateStirrerButtonsUI();
      updateStirrers();
      log("Agitateur 2 " + (state.stirrer2On ? "activ√©" : "d√©sactiv√©") + ".");
    });

    function togglePower() {
      state.poweredOn = !state.poweredOn;
      powerBtnVisible.classList.toggle("off", !state.poweredOn);
      ledPower.classList.toggle("on", state.poweredOn);

      if (state.poweredOn) {
        log("pH-m√®tre allum√©.");
      } else {
        log("pH-m√®tre √©teint.");
        state.currentReading = null;
      }
      updateDisplay();
      updateStirrers();
    }

    powerBtnVisible.addEventListener("click", togglePower);
    powerBtnHidden.addEventListener("click", togglePower);

    function calibrateOn7() {
      if (!state.poweredOn) {
        triggerCalibrationError("le pH-m√®tre doit √™tre allum√© pour r√©gler pH 7.");
        return;
      }
      if (state.part !== "A" || state.currentBecher !== 1) {
        triggerCalibrationError(
          "le r√©glage pH 7 doit √™tre r√©alis√© en Partie A avec l‚Äô√©lectrode dans le tampon pH 7 (B√©cher 1).",
        );
        return;
      }

      state.calibratedMid = true;
      state.calibratedSlope = false;
      state.currentReading = 7.0;
      state.calibrationStep = 1;
      log("Calibration : le pH-m√®tre est r√©gl√© sur pH 7,0 (tampon pH 7).");
      updateDisplay();
    }

    function calibrateOn4() {
      if (!state.poweredOn) {
        triggerCalibrationError("le pH-m√®tre doit √™tre allum√© pour r√©gler pH 4.");
        return;
      }
      if (!state.calibratedMid) {
        triggerCalibrationError(
          "il faut d‚Äôabord r√©gler le pH-m√®tre sur pH 7 avant de r√©gler pH 4.",
        );
        return;
      }
      if (state.part !== "A" || state.currentBecher !== 2) {
        triggerCalibrationError(
          "le r√©glage pH 4 doit √™tre r√©alis√© en Partie A avec l‚Äô√©lectrode dans le tampon pH 4 (B√©cher 2).",
        );
        return;
      }
      if (state.calibrationStep !== 2) {
        triggerCalibrationError(
          "il faut rincer l‚Äô√©lectrode dans le B√©cher 3 entre les tampons pH 7 et pH 4.",
        );
        return;
      }

      state.calibratedSlope = true;
      state.currentReading = 4.0;
      state.rinsedSinceLastSolution = false;
      state.calibrationStep = 3;
      log(
        "Calibration : le pH-m√®tre est r√©gl√© sur pH 4,0. Calibration compl√®te.",
      );
      updateDisplay();
    }

    cal7Btn.addEventListener("click", calibrateOn7);
    calSlopeBtn.addEventListener("click", calibrateOn4);

    function setKnobAngle(el, angle) {
      el.style.transform = "rotate(" + angle + "deg)";
    }

    function updateKnobPreview(type, angle) {
      if (!state.poweredOn) return;

      const valueNorm = (angle - KNOB_MIN) / (KNOB_MAX - KNOB_MIN);

      if (type === "7") {
        if (state.part === "A" && state.currentBecher === 1) {
          const preview = 6 + valueNorm * 2;
          state.currentReading = preview;
          updateDisplay();
        }
      } else if (type === "4") {
        if (state.part === "A" && state.currentBecher === 2 && state.calibratedMid) {
          const preview = 3 + valueNorm * 2;
          state.currentReading = preview;
          updateDisplay();
        }
      }
    }

    function makeKnobInteractive(el, type) {
      let isDragging = false;
      let pointerId = null;
      let center = { x: 0, y: 0 };

      el.addEventListener("pointerdown", (e) => {
        isDragging = true;
        pointerId = e.pointerId;
        el.setPointerCapture(pointerId);
        const rect = el.getBoundingClientRect();
        center = {
          x: rect.left + rect.width / 2,
          y: rect.top + rect.height / 2,
        };
        e.preventDefault();
      });

      el.addEventListener("pointermove", (e) => {
        if (!isDragging || e.pointerId !== pointerId) return;
        const dx = e.clientX - center.x;
        const dy = e.clientY - center.y;
        let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
        if (angle < -180) angle += 360;
        if (angle > 180) angle -= 360;
        angle = Math.max(KNOB_MIN, Math.min(KNOB_MAX, angle));

        if (type === "7") state.knob7Angle = angle;
        else state.knob4Angle = angle;

        setKnobAngle(el, angle);
        updateKnobPreview(type, angle);
      });

      el.addEventListener("pointerup", (e) => {
        if (!isDragging || e.pointerId !== pointerId) return;
        isDragging = false;
        el.releasePointerCapture(pointerId);

        if (type === "7") {
          calibrateOn7();
        } else {
          calibrateOn4();
        }
      });
    }

    function init() {
      attachElectrodeToBecher(4);
      state.currentBecher = 4;
      state.rinsedSinceLastSolution = false;
      state.part = "A";
      state.calibrationStep = 0;
      state.knob7Angle = getRandomKnobAngle();
      state.knob4Angle = getRandomKnobAngle();
      setKnobAngle(knob7, state.knob7Angle);
      setKnobAngle(knob4, state.knob4Angle);
      updatePartUI();
      updateElectrodeStatus();
      updateDisplay();
      updateStirrerButtonsUI();
      updateStirrers();
      makeKnobInteractive(knob7, "7");
      makeKnobInteractive(knob4, "4");
      log(
        "Simulation initialis√©e ‚Äì commence par la Partie A, rince toujours entre deux milieux (B√©cher 3) et mets l‚Äô√©lectrode au repos (B√©cher 4) avant d‚Äôacc√©der aux Parties B et C.",
      );
    }

    init();
  </script>

<script>
(function(){
  function checkOrientation(){
    var isPortrait = false;
    try{
      isPortrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
    }catch(e){
      // fallback: compare viewport
      isPortrait = (window.innerHeight > window.innerWidth);
    }
    document.documentElement.classList.toggle("isPortrait", !!isPortrait);
  }
  window.addEventListener("load", checkOrientation, {passive:true});
  window.addEventListener("resize", checkOrientation, {passive:true});
  window.addEventListener("orientationchange", checkOrientation, {passive:true});
  // initial (important for iOS standalone)
  try{ checkOrientation(); }catch(e){}
})();
</script>

</body>
</html>
