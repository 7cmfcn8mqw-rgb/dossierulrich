<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Réactions ioniques</title>

<style>
body{font-family:Arial,sans-serif;margin:18px;background:#f5f7fb;padding-bottom:calc(var(--final-eq-height, 0px) + 24px + env(safe-area-inset-bottom))}
h1{font-size:18px;margin:0 0 6px}
button{padding:6px 10px;font-size:13px;cursor:pointer;border-radius:10px;border:1px solid #ccc;background:#fff}
button:hover{background:#f0f0f0}

.wrap{
  position:relative;
  display:grid;
  grid-template-columns:auto auto auto auto auto;
  column-gap:12px;
  row-gap:10px;
  align-items:center;
  justify-content:start;
  margin-top:16px;
}
#lineOverlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;overflow:visible}

.equation-cell{
  font-size:26px;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:8px;
}
.reactif{background:#eee;padding:8px 14px;border-radius:12px}
.sym{font-size:28px;font-weight:900}

/* Zone produits (colonne 5) */
.prod-top{
  align-self:start;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  padding-top:2px;
  font-family:inherit;
  font-size:26px;
  font-weight:900;
  color:inherit;
}
.prod-plus{font-size:28px;font-weight:900;line-height:1}

.prodFormula{display:inline}
.precipArrow{
  display:inline-block;
  margin-left:8px;
  font-size:34px;
  font-weight:900;
  line-height:1;
  vertical-align:middle;
}


/* Slots pour coefficients SUR l’équation */
.coefSlot{
  display:inline-flex;
  align-items:center;
  justify-content:flex-end;
  min-width:18px;      /* plus petit = coef plus proche */
  margin-right:4px;    /* petit espace avant la formule */
}

/* Menus coefficients (étape 4) : BLANC + vide par défaut */
.coefSel{
  font-size:14px;
  height:30px;
  border-radius:8px;
  border:2px solid #d2d2d2;
  background:#fff;  /* blanc */
  color:#111;
  padding:2px 6px;
  min-width:42px;
}

.coefSel.fadeOut{
  opacity:0;
  transform:translateY(-4px);
  transition:opacity .25s ease, transform .25s ease;
  pointer-events:none;
}
.coefText{
  display:inline-block;
  min-width:18px;
  text-align:right;
  font-weight:900;
  margin-right:6px;
}
.coefText.coefOne{
  min-width:6px;
  margin-right:6px;
}

/* Menus ions */
.menus-cell{display:flex;justify-content:center}
.menu-stack{
  display:grid;
  gap:8px;
  padding:10px;
  border:2px dashed #d9d9d9;
  border-radius:12px;
  width:fit-content;
  min-width:160px;
}
.mini-select{
  font-size:13px;
  padding:4px 8px;
  height:30px;
  min-width:140px;
  border-radius:8px;
  border:2px solid #d2d2d2;
  background:#fff;
  color:red;
}
select.mini-select option{color:red}

/* Étapes */
.steps{margin-top:20px;font-size:14px}
.step-line{margin:6px 0;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.tick{color:green;font-weight:900;font-size:18px}
.cross{color:darkred;font-weight:900;font-size:18px}
.hidden{display:none}
.smallBtn{padding:5px 9px;font-size:12px}

.ruleBox{
  margin-top:6px;margin-left:8px;padding:8px 10px;border-radius:10px;
  border:1px solid rgba(0,0,0,.12);background:rgba(255,255,255,.7);font-size:13px
}

/* Étape 3 : choix */
#choicesWrap{width:100%;display:flex;gap:16px;flex-wrap:wrap;margin-left:8px}
.choice{
  cursor:pointer;
  user-select:none;
  padding:8px 12px;
  border-radius:12px;
  border:2px solid rgba(0,0,0,.15);
  background:rgba(255,255,255,.65);
  font-weight:900;
  font-size:20px;
  line-height:1.1;
  position:relative;
}
.choice:hover{background:rgba(255,255,255,.9)}
.choice .arrow{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:-18px;
  font-size:20px;
  font-weight:900;
  display:none;
}
.choice.correct{border-color:rgba(16,163,74,.65)}
.choice.correct .arrow{display:block}

/* clignotement traits */
.blink-line{
  stroke:#d10000;
  stroke-width:4.5;
  stroke-linecap:round;
  stroke-dasharray:9 7;
  animation:blink .55s linear infinite;
  filter:drop-shadow(0 0 2px rgba(209,0,0,.45));
}
@keyframes blink{0%,100%{opacity:.25}50%{opacity:1}}

.tabs{
  display:flex;
  gap:10px;
  margin:10px 0 16px;
}
.tab{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.18);
  background:#fff;
  font-weight:800;
}
.tab.active{
  border-color:rgba(16,163,74,.7);
  box-shadow:0 0 0 3px rgba(16,163,74,.18);
}

/* animation onglets */
#main{
  transition: opacity .18s ease, transform .18s ease;
}
#main.anim-out{
  opacity:0;
  transform: translateY(8px);
}


/* Indices (subscripts) : affichage propre et non ambigu */
sub{
  font-size: 0.65em;
  line-height: 0;
  vertical-align: -0.35em;
}
sup{
  font-size: 0.65em;
  line-height: 0;
  vertical-align: 0.5em;
}


.version-label{
  transform: scale(0.5);
  transform-origin: bottom right;

  position:fixed;
  bottom:12px;
  right:12px;
  padding:10px 14px;
  border:2px solid #333;
  border-radius:10px;
  background:#fff;
  font-size:14px;
  font-weight:700;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}



/* ========= Responsive (téléphone / iPad en paysage) ========= */
/* iPad & tablettes en paysage */
@media (max-width: 1024px) and (orientation: landscape){
  body{margin:12px}
  h1{font-size:18px}
  .tabs{margin-top:6px;margin-bottom:14px;gap:8px;flex-wrap:wrap}
  .tab{padding:7px 12px;border-radius:12px;font-size:14px}
  .wrap{margin-top:38px;column-gap:10px;row-gap:10px}
  .equation-cell{font-size:22px}
  .reactif{padding:6px 12px;border-radius:12px}
  .sym{font-size:24px}
  .prod-top{font-size:22px;gap:8px}
  .prod-plus{font-size:24px}
  .menu-stack{padding:8px;min-width:150px}
  .mini-select{min-width:130px;height:30px}
  .coefSel{min-width:46px;height:30px}
  .coefSlot{min-width:34px;margin-right:4px}
  .steps{font-size:13px}
  button{font-size:13px}
  .version-label{
  transform: scale(0.5);
  transform-origin: bottom right;
font-size:12px;padding:8px 12px;bottom:10px;right:10px}
}

/* Téléphones en paysage */
@media (max-width: 812px) and (orientation: landscape){
  body{margin:10px}
  h1{font-size:17px;margin-bottom:10px}
  .wrap{
    margin-top:34px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    padding-bottom:10px;
  }
  .equation-cell{font-size:20px}
  .reactif{padding:5px 10px;border-radius:12px}
  .sym{font-size:22px}
  .prod-top{font-size:20px}
  .menu-stack{min-width:140px}
  .mini-select{min-width:120px;height:28px}
  .coefSel{min-width:42px;height:28px}
  .coefSlot{min-width:30px;margin-right:3px}
  .choice{font-size:18px}
  .version-label{
  transform: scale(0.5);
  transform-origin: bottom right;
font-size:11px;padding:7px 10px}
}

/* Très petits écrans (sécurité) */
@media (max-width: 680px) and (orientation: landscape){
  .equation-cell{font-size:18px}
  .prod-top{font-size:18px}
  .choice{font-size:16px}
}


/* Fade-out des menus d'ions quand on passe à l'équilibrage */
.menus-fading{
  opacity:0;
  transform:translateY(6px);
  pointer-events:none;
  transition:opacity .35s ease, transform .35s ease;
}
.menus-visible{
  opacity:1;
  transform:none;
  transition:opacity .35s ease, transform .35s ease;
}


/* Produits : même style que les réactifs (pills), dans les 2 volets */
.prodFormula{
  background:#eee;
  padding:10px 16px;
  border-radius:16px;
  display:inline-block;   /* IMPORTANT : pas flex, pour que sub/sup fonctionnent bien */
  font-weight:900;
}
.prod-top{gap:12px; flex-wrap:wrap;}


/* Logo / bouton en haut à droite (lien) */
.nav-logo{
  position:fixed;
  top:12px;
  right:12px;
  z-index:10000;
  width:44px;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  border:1px solid #ccc;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  font-size:22px;
  font-weight:900;
  line-height:1;
  text-decoration:none;
  color:#111;
}
.nav-logo:hover{background:#f0f0f0}
@media (max-width: 812px) and (orientation: landscape){
  .nav-logo{top:10px;right:10px;width:40px;height:40px;font-size:20px}
}


/* ===== Affichage final (équation complète) ===== */
.final-equation{
  position:fixed;
  bottom:12px;
  left:12px;
  right:140px; /* laisse la place à l'étiquette version en bas à droite */
  font-size:12pt;              /* police réelle 12 */
  font-family:Arial,sans-serif;
  font-weight:normal;
  background:#fff;
  border:1px solid rgba(0,0,0,.22);
  border-radius:10px;
  padding:8px 12px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  z-index:10001;
}

@media (max-width: 600px){
  .final-equation{
    left:0;
    right:0;
    bottom:0;
    max-width:none;
    border-radius:0;
    margin:0;
    box-sizing:border-box;
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
  }
  .version-label{
    bottom:calc(8px + var(--final-eq-height, 0px) + env(safe-area-inset-bottom));
    right:8px;
    transform:scale(0.45);
  }
}


.final-equation b{font-weight:700}
.final-equation i{font-style:italic}
@media (max-width: 812px) and (orientation: landscape){
  .final-equation{right:120px;font-size:12pt;padding:7px 10px}
}

</style>
</head>

<body>

<a class="nav-logo" href="https://7cmfcn8mqw-rgb.github.io/dossierulrich/" aria-label="Ouvrir le dossier Ulrich">←</a>

<h1>Réactions ioniques</h1>

<div class="tabs">
  <button class="tab active" id="tabPrecip" type="button">Précipitation</button>
  <button class="tab" id="tabNeut" type="button">Neutralisation</button>
</div>

<div id="main">
<button id="btnNew">Nouvelle équation</button>

<div class="wrap" id="grid"></div>

<div class="steps">
  <div class="step-line">
    <strong>Étape 1 :</strong> Identifier les ions des réactifs
    <button id="btnCheckIons">Vérifier</button>
    <span id="ok1" class="tick hidden">✓</span>
    <span id="bad1" class="cross hidden">✗</span>
  </div>

  <div class="step-line hidden" id="step2">
    <strong>Étape 2 :</strong>
    Créer deux nouvelles molécules neutres (produits) en recombinant les ions
    <button id="btnRunStep2" class="smallBtn">Lancer l’étape 2</button>
  </div>

  <div class="step-line hidden" id="step2b">
    <button id="btnTo3">Passer à l’étape 3</button>
  </div>

  <div class="step-line hidden" id="step3">
    <strong id="labelStep3">Étape 3 :</strong> Déterminer le précipité (clique sur la bonne molécule)
    <span id="ok3" class="tick hidden">✓</span>
    <span id="bad3" class="cross hidden">✗</span>
    <div id="choicesWrap"></div>
    <div id="ruleMsg" class="ruleBox hidden">
      Règle : le précipité <b>ne contient pas</b> de métal de la colonne IA (Li, Na, K, Rb, Cs),
      ni <b>NH₄⁺</b>, ni <b>NO₃⁻</b> ou <b>NO₂⁻</b>.
      Donc c’est forcément <b>un des deux produits</b>. Tu peux recliquer.
    </div>
  </div>

  <div class="step-line hidden" id="step4">
    <strong id="labelStep4">Étape 4 :</strong> Équilibrer l’équation (coefficients 1 à 12)
    <span id="ok4" class="tick hidden">✓</span>
    <span id="bad4" class="cross hidden">✗</span>
    <button id="btnCheckBal" class="smallBtn">Vérifier l’équilibrage</button>
    <div id="balMsg" class="ruleBox hidden">
      Pas équilibré : compare le nombre d’atomes de chaque élément à gauche et à droite, puis ajuste les coefficients.
    </div>
  </div>
</div>

<script>
/* ==== Données / équations ==== */
const equationsPrecipitation = [
  "AgNO3 + NaCl",
  "AgNO3 + Na2CO3",
  "AgNO3 + NaOH",
  "BaCl2 + Na2SO4",
  "BaCl2 + Na2CO3",
  "CaCl2 + Na2CO3",
  "CuSO4 + NaOH",
  "CuSO4 + Na2CO3"
];

const equationsNeutralisation = [
  "HCl + NaOH",
  "HCl + Ba(OH)2",
  "HCl + Ca(OH)2",
  "HCl + Cu(OH)2",

  "HNO3 + NaOH",
  "HNO3 + Ba(OH)2",
  "HNO3 + Ca(OH)2",
  "HNO3 + Cu(OH)2",

  "H2SO4 + NaOH",
  "H2SO4 + Ba(OH)2",
  "H2SO4 + Ca(OH)2",

  "H2CO3 + NaOH",
  "H2CO3 + Ba(OH)2",
  "H2CO3 + Ca(OH)2"
];

function getEquationsForMode(){
  return (MODE === "neutralisation") ? equationsNeutralisation : equationsPrecipitation;
}


/* ==== Tirage sans répétition immédiate (pioche mélangée) ==== */
let eqBag = [];
let lastEq = null;

function shuffleInPlace(array){
  for(let i=array.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
}
function refillBag(){
  eqBag = getEquationsForMode().slice();
  shuffleInPlace(eqBag);
}

const cations = ["Ag+","Na+","Ba2+","Ca2+","Cu2+","H+"];
const anions  = ["Cl-","NO3-","SO4^2-","CO3^2-","OH-"];

const expected = {
 "AgNO3": {c:"Ag+", a:"NO3-"},
 "NaCl":  {c:"Na+", a:"Cl-"},
 "BaCl2": {c:"Ba2+",a:"Cl-"},
 "Na2SO4":{c:"Na+", a:"SO4^2-"},
 "CaCl2": {c:"Ca2+",a:"Cl-"},
 "Na2CO3":{c:"Na+", a:"CO3^2-"},
 "CuSO4": {c:"Cu2+",a:"SO4^2-"},
 "NaOH":  {c:"Na+", a:"OH-"},
 "HCl":     {c:"H+",  a:"Cl-"},
 "HNO3":    {c:"H+",  a:"NO3-"},
 "H2SO4":   {c:"H+",  a:"SO4^2-"},
 "H2CO3":   {c:"H+",  a:"CO3^2-"},
 "Ba(OH)2": {c:"Ba2+",a:"OH-"},
 "Ca(OH)2": {c:"Ca2+",a:"OH-"},
 "Cu(OH)2": {c:"Cu2+",a:"OH-"}
};

let r1="", r2="";
let PROD1="", PROD2="", PRECIP="";
let animToken = 0;

let MODE = null; // "precipitation" | "neutralisation"

function setMode(mode){
  if(mode===MODE) return;
  const main = document.getElementById("main");
  if(main) main.classList.add("anim-out");

  // on attend la petite transition avant de changer le mode
  setTimeout(() => {
    MODE = mode;
    eqBag = [];
    lastEq = null;

    document.getElementById("tabPrecip").classList.toggle("active", MODE==="precipitation");
    document.getElementById("tabNeut").classList.toggle("active", MODE==="neutralisation");

    const step3 = document.getElementById("step3");
    const label4 = document.getElementById("labelStep4");

    // on vide l’équation finale quand on change de mode
    hideFinalEquation();


    if(MODE==="neutralisation"){
      // on retire l’étape du précipité et on renumérote l’équilibrage
      if(step3) step3.classList.add("hidden");
      if(label4) label4.textContent = "Étape 3 :";
      document.getElementById("btnTo3").textContent = "Passer à l’équilibrage";
      document.querySelectorAll(".precipArrow").forEach(x=>x.remove());
    }else{
    hideFinalEquation();
      if(label4) label4.textContent = "Étape 4 :";
      document.getElementById("btnTo3").textContent = "Passer à l’équilibrage";
    }

    // reset + nouvelle situation
    pick();

    if(main){
      // force reflow pour relancer l'animation proprement
      void main.offsetWidth;
      main.classList.remove("anim-out");
    }
  }, 180);
}


/* ==== rendu indices HTML ==== */
function indiceHTML(f){ return f.replace(/([A-Za-z)])(\d+)/g,"$1<sub>$2</sub>"); }
function formulaToHTML(f){ return indiceHTML(f); }

/* ==== MENUS : indices unicode / charges exposants unicode ==== */
const subMap = { "0":"₀","1":"₁","2":"₂","3":"₃","4":"₄","5":"₅","6":"₆","7":"₇","8":"₈","9":"₉" };
const supMap = { "0":"⁰","1":"¹","2":"²","3":"³","4":"⁴","5":"⁵","6":"⁶","7":"⁷","8":"⁸","9":"⁹","+":"⁺","-":"⁻" };
const toSub = s => s.replace(/\d/g, d => subMap[d] || d);
const toSup = s => s.replace(/[0-9+-]/g, c => supMap[c] || c);

function formatCation(x){
  // Affiche la charge en exposant (ex: Ba²⁺, Cu²⁺, Na⁺)
  const m = x.match(/^(.+?)(\d*)\+$/);
  if(!m) return x;
  const base = m[1];
  const n = m[2] || "";
  return base + toSup(n + "+");
}
function formatAnion(x){
  if(x.includes("^")){
    const p=x.split("^");
    return toSub(p[0]) + toSup(p[1]); // SO₄²⁻
  }
  const base = x.replace("-","");
  return toSub(base) + supMap["-"];
}
function makeSelect(list, formatter, id){
  const s=document.createElement("select");
  s.className="mini-select";
  if(id) s.id=id;
  for(const x of list){
    const o=document.createElement("option");
    o.value=x; o.textContent=formatter(x);
    s.appendChild(o);
  }
  return s;
}

/* ==== Construction produits (croisement charges) ==== */
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a||1; }
function gcdArray(arr){
  return arr.reduce((g,v)=>gcd(g,v),0);
}
function chargeOfCation(raw){
  const m = raw.match(/(\d*)\+$/);
  if(!m) return null;
  return m[1] ? parseInt(m[1],10) : 1;
}
function chargeOfAnion(raw){
  if(raw.includes("^")){
    const m = raw.match(/\^(\d+)-$/);
    return m ? -parseInt(m[1],10) : null;
  }
  return raw.endsWith("-") ? -1 : null;
}
function baseOfCation(raw){ return raw.replace(/(\d*)\+$/,""); }
function baseOfAnion(raw){
  if(raw.includes("^")) return raw.split("^")[0];
  return raw.replace(/-$/,"");
}
function needsParens(group){
  // Parenthèses nécessaires pour ions polyatomiques
  // ex : OH, NO3, SO4, CO3
  return /[A-Z][a-z]?[A-Z]/.test(group) || /OH|NO3|SO4|CO3/.test(group);
}
function withCount(group,n){
  if(n===1) return group;
  return (needsParens(group) ? "(" + group + ")" : group) + String(n);
}
function buildNeutralFormula(cationRaw, anionRaw){
  // Cas particulier neutralisation : H+ + OH- = H2O
  if(baseOfCation(cationRaw)==="H" && baseOfAnion(anionRaw)==="OH"){
    return "H2O";
  }

  const zP = chargeOfCation(cationRaw);
  const zM = Math.abs(chargeOfAnion(anionRaw));
  if(!zP || !zM) return "";
  const g = gcd(zP, zM);
  const nCat = zM / g;
  const nAn  = zP / g;
  return withCount(baseOfCation(cationRaw), nCat) + withCount(baseOfAnion(anionRaw), nAn);
}

/* ==== Règle précipité ==== */
function isPrecipitateByRule(formula){
  const f = formula || "";
  if (f.startsWith("Li") || f.startsWith("Na") || f.startsWith("K") || f.startsWith("Rb") || f.startsWith("Cs")) return false;
  if (f.startsWith("NH4")) return false;
  if (f.includes("NO3") || f.includes("NO2")) return false;
  return true;
}

/* ==== Overlay lignes ==== */
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function getCenterRelativeToWrap(el, wrapEl){
  const r = el.getBoundingClientRect();
  const w = wrapEl.getBoundingClientRect();
  return { x:(r.left+r.right)/2-w.left, y:(r.top+r.bottom)/2-w.top };
}
function clearOverlay(){ const svg=document.getElementById("lineOverlay"); if(svg) svg.remove(); }
function ensureOverlay(){
  const wrap=document.getElementById("grid");
  let svg=document.getElementById("lineOverlay");
  if(!svg){
    svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.id="lineOverlay";
    wrap.appendChild(svg);
  }
  const w=wrap.getBoundingClientRect();
  svg.setAttribute("width",w.width);
  svg.setAttribute("height",w.height);
  svg.setAttribute("viewBox",`0 0 ${w.width} ${w.height}`);
  svg.innerHTML="";
  return svg;
}
function drawBlinkLine(fromEl,toEl){
  const wrap=document.getElementById("grid");
  const svg=ensureOverlay();
  const a=getCenterRelativeToWrap(fromEl,wrap);
  const b=getCenterRelativeToWrap(toEl,wrap);
  const line=document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1",a.x); line.setAttribute("y1",a.y);
  line.setAttribute("x2",b.x); line.setAttribute("y2",b.y);
  line.setAttribute("class","blink-line");
  svg.appendChild(line);
  return line;
}

/* ==== Produits (affichage) ==== */
function setTopProducts(html){ document.getElementById("prodBox").innerHTML = html; }

function markPrecipInMain(){
  // Nettoie d'abord
  document.querySelectorAll(".precipArrow").forEach(x=>x.remove());
  const p1 = document.getElementById("prod1Main");
  const p2 = document.getElementById("prod2Main");
  if(!p1 || !p2) return;
  const target = (PRECIP===PROD1) ? p1 : (PRECIP===PROD2 ? p2 : null);
  if(!target) return;
  const tag = document.createElement("span");
  tag.className = "precipArrow";
  tag.textContent = "↓";
  target.appendChild(tag);
}


/* ==== Étape 3 ==== */
function resetStep3(){
  document.getElementById("step3").classList.add("hidden");
  document.getElementById("ok3").classList.add("hidden");
  document.getElementById("bad3").classList.add("hidden");
  document.getElementById("ruleMsg").classList.add("hidden");
  document.getElementById("choicesWrap").innerHTML="";
}
function clearChoiceMarks(){
  document.querySelectorAll(".choice").forEach(c=>c.classList.remove("correct"));
}

function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function showStep3Choices(){
  document.getElementById("step3").classList.remove("hidden");
  document.getElementById("ok3").classList.add("hidden");
  document.getElementById("bad3").classList.add("hidden");
  document.getElementById("ruleMsg").classList.add("hidden");

  const choicesWrap=document.getElementById("choicesWrap");
  choicesWrap.innerHTML="";

  const items=[{label:r1, kind:"reactif"},
    {label:r2, kind:"reactif"},
    {label:PROD1, kind:"produit"},
    {label:PROD2, kind:"produit"}];

  // Mélange aléatoire des propositions (bonne position variable)
  shuffleArray(items);

  for(const it of items){
    const div=document.createElement("div");
    div.className="choice";
    div.innerHTML = `${formulaToHTML(it.label)}`;
    div.addEventListener("click",()=>{
      clearChoiceMarks();
      const ok = (it.kind==="produit") && (it.label===PRECIP);
      if(ok){
        div.classList.add("correct");
        document.getElementById("ok3").classList.remove("hidden");
        document.getElementById("bad3").classList.add("hidden");
        document.getElementById("ruleMsg").classList.add("hidden");
        if(MODE==="precipitation") markPrecipInMain();
        showStep4();
      }else{
        document.getElementById("ok3").classList.add("hidden");
        document.getElementById("bad3").classList.remove("hidden");
        document.getElementById("ruleMsg").classList.remove("hidden");
      }
    });
    choicesWrap.appendChild(div);
  }
}

/* ==== Étape 4 : menus coefficients SUR l’équation ==== */
function coefSelect(id){
  const s=document.createElement("select");
  s.className="coefSel";
  s.id=id;

  // ✅ 1 par défaut (modifiable)
  for(let n=1;n<=12;n++){
    const o=document.createElement("option");
    o.value=String(n);
    o.textContent=String(n);
    if(n===1) o.selected=true;
    s.appendChild(o);
  }
  return s;
}
function clearCoefSlots(){
  ["coefR1","coefR2","coefP1","coefP2"].forEach(id=>{
    const slot=document.getElementById(id);
    if(slot) slot.innerHTML="";
  });
}
function mountCoefSelectors(){
  clearCoefSlots();
  document.getElementById("coefR1").appendChild(coefSelect("a1"));
  document.getElementById("coefR2").appendChild(coefSelect("a2"));
  document.getElementById("coefP1").appendChild(coefSelect("a3"));
  document.getElementById("coefP2").appendChild(coefSelect("a4"));
}
function finalizeCoefDisplay(){
  const mapping = [
    {selId:"a1", slotId:"coefR1"},
    {selId:"a2", slotId:"coefR2"},
    {selId:"a3", slotId:"coefP1"},
    {selId:"a4", slotId:"coefP2"},
  ];
  mapping.forEach(({selId, slotId})=>{
    const sel = document.getElementById(selId);
    const slot = document.getElementById(slotId);
    if(!sel || !slot) return;

    const v = parseInt(sel.value,10);
    // fade out the select then replace by text (show only if != 1)
    sel.classList.add("fadeOut");
    window.setTimeout(()=>{
      slot.innerHTML = "";
      const span = document.createElement("span");
      span.className = "coefText" + (v===1 ? " coefOne" : "");
      span.textContent = (v===1 ? "" : String(v));
      slot.appendChild(span);
    }, 260);
  });
}

function resetStep4(){
  document.getElementById("step4").classList.add("hidden");
  document.getElementById("ok4").classList.add("hidden");
  document.getElementById("bad4").classList.add("hidden");
  document.getElementById("balMsg").classList.add("hidden");
  clearCoefSlots();
}

function fadeOutIonMenus(){
  document.querySelectorAll('.menus-cell').forEach(el=>{
    el.classList.remove('menus-visible');
    el.classList.add('menus-fading');
  });
}
function showIonMenus(){
  document.querySelectorAll('.menus-cell').forEach(el=>{
    el.classList.remove('menus-fading');
    el.classList.add('menus-visible');
  });
}

function showStep4(){
  document.getElementById("step4").classList.remove("hidden");
  fadeOutIonMenus();
  document.getElementById("ok4").classList.add("hidden");
  document.getElementById("bad4").classList.add("hidden");
  document.getElementById("balMsg").classList.add("hidden");

  // ✅ place les menus sur l’équation (sans auto-remplir)
  mountCoefSelectors();
}

/* Parser formule -> {Elt:count} (parenthèses OK) */
function parseFormulaCounts(formula){
  const tokens = [];
  let i=0;
  while(i<formula.length){
    const ch=formula[i];
    if(ch==="(" || ch===")"){ tokens.push(ch); i++; continue; }
    if(ch>="0" && ch<="9"){
      let j=i; while(j<formula.length && formula[j]>="0" && formula[j]<="9") j++;
      tokens.push(formula.slice(i,j)); i=j; continue;
    }
    if(ch>="A" && ch<="Z"){
      let j=i+1;
      if(j<formula.length && formula[j]>="a" && formula[j]<="z") j++;
      tokens.push(formula.slice(i,j)); i=j; continue;
    }
    i++;
  }

  const stack=[{}];
  const add=(map,el,n)=>{ map[el]=(map[el]||0)+n; };

  let k=0;
  while(k<tokens.length){
    const t=tokens[k];
    if(t==="("){ stack.push({}); k++; }
    else if(t===")"){
      const group=stack.pop(); k++;
      let mult=1;
      if(k<tokens.length && /^[0-9]+$/.test(tokens[k])){ mult=parseInt(tokens[k],10); k++; }
      const top=stack[stack.length-1];
      for(const el in group) add(top, el, group[el]*mult);
    } else if(/^[A-Z]/.test(t)){
      let mult=1;
      if(k+1<tokens.length && /^[0-9]+$/.test(tokens[k+1])){ mult=parseInt(tokens[k+1],10); k++; }
      add(stack[stack.length-1], t, mult); k++;
    } else { k++; }
  }
  return stack[0];
}
function scaleCounts(counts, factor){
  const out={};
  for(const el in counts) out[el]=counts[el]*factor;
  return out;
}
function addMaps(a,b){
  const out={...a};
  for(const el in b) out[el]=(out[el]||0)+b[el];
  return out;
}
function equalMaps(a,b){
  const keys=new Set([...Object.keys(a),...Object.keys(b)]);
  for(const k of keys){ if((a[k]||0)!==(b[k]||0)) return false; }
  return true;
}
function checkBalance(){
  const a1s=document.getElementById("a1")?.value || "1";
  const a2s=document.getElementById("a2")?.value || "1";
  const a3s=document.getElementById("a3")?.value || "1";
  const a4s=document.getElementById("a4")?.value || "1";

  const a1=parseInt(a1s,10), a2=parseInt(a2s,10), a3=parseInt(a3s,10), a4=parseInt(a4s,10);

  const L = addMaps(
    scaleCounts(parseFormulaCounts(r1), a1),
    scaleCounts(parseFormulaCounts(r2), a2)
  );
  const R = addMaps(
    scaleCounts(parseFormulaCounts(PROD1), a3),
    scaleCounts(parseFormulaCounts(PROD2), a4)
  );

  const balanced = equalMaps(L,R);

  // ✅ coefficients au minimum : pas de facteur commun > 1
  const g = gcdArray([a1,a2,a3,a4]);
  const minimal = (g===1);

  const ok = balanced && minimal;

  const balMsgEl = document.getElementById("balMsg");
  if(balMsgEl){
    if(!balanced){
      balMsgEl.textContent = "Pas équilibré : compare le nombre d’atomes de chaque élément à gauche et à droite, puis ajuste les coefficients.";
    }else if(!minimal){
      balMsgEl.textContent = `Équation équilibrée, mais les coefficients ne sont pas au minimum : divise tous les coefficients par ${g}.`;
    }
  }

  document.getElementById("ok4").classList.toggle("hidden", !ok);
  document.getElementById("bad4").classList.toggle("hidden", ok);
  document.getElementById("balMsg").classList.toggle("hidden", ok);

  if(ok){ finalizeCoefDisplay(); showFinalEquation(); } else { hideFinalEquation(); }
}



function updateFinalEquationLayout(){
  const el = document.getElementById("finalEquation");
  if(!el) return;
  // hidden => height 0
  const hidden = el.classList.contains("hidden") || getComputedStyle(el).display === "none";
  const h = hidden ? 0 : el.offsetHeight;
  document.documentElement.style.setProperty("--final-eq-height", h + "px");
}
window.addEventListener("resize", updateFinalEquationLayout);

function showFinalEquation(){
  const box = document.getElementById("finalEquation");
  if(!box) return;

  let texte = "";
  let equation = "";

  if(MODE === "precipitation"){
    texte = "<b>L’équation équilibrée de la réaction de précipitation est :</b><br>";
    const p1 = (PRECIP === PROD1) ? " ↓" : "";
    const p2 = (PRECIP === PROD2) ? " ↓" : "";
    equation = `${r1} + ${r2} → ${PROD1}${p1} + ${PROD2}${p2}`;
  }

  if(MODE === "neutralisation"){
    texte =
      "<b>L’équation équilibrée de la réaction de neutralisation est :</b><br>" +
      "<i>Un acide et une base forment un sel et de l’eau.</i><br>";
    equation = `${r1} + ${r2} → ${PROD1} + ${PROD2}`;
  }

  box.innerHTML = texte + indiceHTML(equation);
  box.classList.remove("hidden");
  requestAnimationFrame(updateFinalEquationLayout);
}
function hideFinalEquation(){
  const box = document.getElementById("finalEquation");
  if(!box) return;
  box.innerHTML = "";
  box.classList.add("hidden");
  updateFinalEquationLayout();
}


/* ==== Étape 2 animation ==== */
async function runRecombineAnimation(){
  const token = ++animToken;

  const cat1=document.getElementById("cat1");
  const an1 =document.getElementById("an1");
  const cat2=document.getElementById("cat2");
  const an2 =document.getElementById("an2");
  if(!cat1||!an1||!cat2||!an2) return;

  PROD1 = buildNeutralFormula(cat1.value, an2.value); // cation1 + anion2
  PROD2 = buildNeutralFormula(cat2.value, an1.value); // cation2 + anion1

  const p1prec = isPrecipitateByRule(PROD1);
  const p2prec = isPrecipitateByRule(PROD2);
  if (p1prec && !p2prec) PRECIP = PROD1;
  else if (!p1prec && p2prec) PRECIP = PROD2;
  else if (p1prec && p2prec) PRECIP = PROD1;
  else PRECIP = PROD1;

  // Phase 1 : ligne + produit 1
  clearOverlay();
  if(token!==animToken) return;
  setTopProducts(
    `<span class="coefSlot" id="coefP1"></span><span class="prodFormula" id="prod1Main">${formulaToHTML(PROD1)}</span>`
  );
  drawBlinkLine(cat1, an2);
  await sleep(5000);
  if(token!==animToken) return;

  clearOverlay();
  await sleep(2000);
  if(token!==animToken) return;

  // Phase 2 : ligne + produit 2
  setTopProducts(
    `<span class="coefSlot" id="coefP1"></span><span class="prodFormula" id="prod1Main">${formulaToHTML(PROD1)}</span> <span class="prod-plus">+</span> <span class="coefSlot" id="coefP2"></span><span class="prodFormula" id="prod2Main">${formulaToHTML(PROD2)}</span>`
  );
  drawBlinkLine(cat2, an1);
  await sleep(5000);
  if(token!==animToken) return;

  clearOverlay();
  if(token!==animToken) return;

  // fin étape 2 -> bouton étape 3
  document.getElementById("step2b").classList.remove("hidden");
}

/* ==== UI générale ==== */
function resetAllSteps(){
  document.getElementById("ok1").classList.add("hidden");
  document.getElementById("bad1").classList.add("hidden");
  document.getElementById("step2").classList.add("hidden");
  document.getElementById("step2b").classList.add("hidden");
  resetStep3();
  resetStep4();
  clearOverlay();
  clearCoefSlots();
}

function pick(){
  animToken++;
  resetAllSteps();

  if(eqBag.length===0) refillBag();
  let eq = eqBag.pop();

  // évite la même équation deux fois de suite (si possible)
  if(lastEq && eq===lastEq && eqBag.length>0){
    eqBag.unshift(eq);
    eq = eqBag.pop();
  }
  lastEq = eq;

  [r1,r2]=eq.split(" + ").map(x=>x.trim());
  render();
}

function render(){
  const g=document.getElementById("grid");
  g.innerHTML="";

  // Réactif 1 avec slot coef
  g.innerHTML += `
    <div class="equation-cell">
      <span class="coefSlot" id="coefR1"></span>
      <span class="reactif">${indiceHTML(r1)}</span>
    </div>`;

  g.innerHTML += `<div class="sym">+</div>`;

  // Réactif 2 avec slot coef
  g.innerHTML += `
    <div class="equation-cell">
      <span class="coefSlot" id="coefR2"></span>
      <span class="reactif">${indiceHTML(r2)}</span>
    </div>`;

  g.innerHTML += `<div class="sym">→</div>`;

  // Produits (colonne 5)
  g.innerHTML += `
    <div class="prod-top">
      <span id="prodBox"></span>
    </div>
  `;

  // Menus ions
  const m1=document.createElement("div");
  m1.className="menus-cell menus-visible";
  const s1=document.createElement("div");
  s1.className="menu-stack";
  s1.appendChild(makeSelect(cations, formatCation, "cat1"));
  s1.appendChild(makeSelect(anions,  formatAnion,  "an1"));
  m1.appendChild(s1);

  const m2=document.createElement("div");
  m2.className="menus-cell menus-visible";
  const s2=document.createElement("div");
  s2.className="menu-stack";
  s2.appendChild(makeSelect(cations, formatCation, "cat2"));
  s2.appendChild(makeSelect(anions,  formatAnion,  "an2"));
  m2.appendChild(s2);

  g.appendChild(m1);
  g.appendChild(document.createElement("div"));
  g.appendChild(m2);

  setTopProducts(""); // rien au départ

  // menus visibles au départ
  if (typeof showIonMenus === "function") showIonMenus();
}

function checkStep1(){
  const sel=document.querySelectorAll("select");
  const ok =
    sel[0].value===expected[r1].c &&
    sel[1].value===expected[r1].a &&
    sel[2].value===expected[r2].c &&
    sel[3].value===expected[r2].a;

  document.getElementById("ok1").classList.toggle("hidden", !ok);
  document.getElementById("bad1").classList.toggle("hidden", ok);

  // Étape 2 visible si OK, mais animation pas auto
  document.getElementById("step2").classList.toggle("hidden", !ok);

  if(!ok){
    hideFinalEquation();
    animToken++;
    clearOverlay();
    document.getElementById("step2b").classList.add("hidden");
    resetStep3();
    resetStep4();
    clearCoefSlots();
    setTopProducts("");
  }else{
    document.getElementById("step2b").classList.add("hidden");
    resetStep3();
    resetStep4();
    clearCoefSlots();
  }
}

/* ==== Events ==== */

document.getElementById("tabPrecip").onclick = () => { if(MODE!=="precipitation") setMode("precipitation"); };
document.getElementById("tabNeut").onclick = () => { if(MODE!=="neutralisation") setMode("neutralisation"); };

document.getElementById("btnNew").onclick = pick;
document.getElementById("btnCheckIons").onclick = checkStep1;

document.getElementById("btnRunStep2").onclick = () => {
  if(!document.getElementById("ok1").classList.contains("hidden")){
    document.getElementById("step2b").classList.add("hidden");
    resetStep3();
    resetStep4();
    clearCoefSlots();
    runRecombineAnimation();
  }
};

document.getElementById("btnTo3").onclick = () => {
  if (typeof fadeOutIonMenus === "function") fadeOutIonMenus();
if(MODE==="precipitation") showStep3Choices();
  else showStep4();
};

document.getElementById("btnCheckBal").onclick = () => {
  checkBalance();
};

window.addEventListener("resize", () => {
  const svg=document.getElementById("lineOverlay");
  if(svg) ensureOverlay();
});

// mode par défaut
setMode("precipitation");

// Sécurité : si un autre bouton "passer à l'équilibrage" existe, on applique aussi le fade-out
(function(){
  const ids = ["btnToBal","btnTo4","btnToEq","btnEquilibrage"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("click", ()=>{ if (typeof fadeOutIonMenus === "function") fadeOutIonMenus(); }, {capture:true});
    }
  });
})();

</script>
</div>




<!-- Équation finale (affichée uniquement quand tout est juste) -->
<div id="finalEquation" class="final-equation hidden"></div>

<div class="version-label">
  Version 2.8<br>
  S. Ulrich — ECG Henry‑Dunant
</div>

</body>
</html>
